<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>ru.spb.iac.cud: git/acc/ru.spb.iac.cud/sts-web/src/main/java/ru/spb/iac/sts/core/plugins/saml/CUDSAML20TokenProvider.java Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ru.spb.iac.cud
   &#160;<span id="projectnumber">0.0.1-SNAPSHOT</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../namespaces.html"><span>Packages</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">CUDSAML20TokenProvider.java</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="../../d6/d04/namespaceru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml.html">    1</a></span>&#160;<span class="keyword">package </span>ru.spb.iac.sts.core.plugins.saml;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">import</span> java.security.Principal;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">import</span> java.util.ArrayList;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">import</span> java.util.HashMap;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">import</span> java.util.List;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">import</span> java.util.Map;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">import</span> javax.xml.namespace.QName;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.common.PicketLinkLogger;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.common.PicketLinkLoggerFactory;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.common.constants.JBossSAMLConstants;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.common.constants.JBossSAMLURIConstants;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.common.constants.WSTrustConstants;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.common.exceptions.ProcessingException;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.common.util.DocumentUtil;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.interfaces.ProtocolContext;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.interfaces.SecurityTokenProvider;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.saml.v2.common.IDGenerator;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.saml.v2.factories.SAMLAssertionFactory;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.saml.v2.util.AssertionUtil;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.saml.v2.util.StatementUtil;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.sts.AbstractSecurityTokenProvider;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.wstrust.SecurityToken;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.wstrust.StandardSecurityToken;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.wstrust.WSTrustRequestContext;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.wstrust.WSTrustUtil;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.wstrust.plugins.saml.SAML20TokenAttributeProvider;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.wstrust.plugins.saml.SAMLUtil;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.core.wstrust.wrappers.Lifetime;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.AssertionType;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.AttributeStatementType;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.AttributeType;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.AudienceRestrictionType;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.ConditionsType;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.KeyInfoConfirmationDataType;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.NameIDType;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.StatementAbstractType;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.SubjectConfirmationDataType;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.SubjectConfirmationType;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.SubjectType;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.ws.policy.AppliesTo;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.ws.trust.RequestedReferenceType;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.ws.trust.StatusType;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.ws.wss.secext.KeyIdentifierType;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.slf4j.Logger;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.slf4j.LoggerFactory;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="keyword">import</span> <a class="code" href="../../db/d96/namespaceorg.html">org</a>.w3c.dom.Element;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keyword">import</span> <a class="code" href="../../d6/d63/namespaceru.html">ru</a>.<a class="code" href="../../d6/d49/namespaceru_1_1spb.html">spb</a>.<a class="code" href="../../db/dae/namespaceru_1_1spb_1_1iac.html">iac</a>.<a class="code" href="../../d1/df1/namespaceru_1_1spb_1_1iac_1_1cud.html">cud</a>.<a class="code" href="../../d8/df8/namespaceru_1_1spb_1_1iac_1_1cud_1_1sts.html">sts</a>.<a class="code" href="../../d0/d1b/namespaceru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core.html">core</a>.<a class="code" href="../../d0/d24/namespaceru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core_1_1attrib.html">attrib</a>.<a class="code" href="../../d2/dca/classru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core_1_1attrib_1_1_c_u_d_s_a_m_l20_common_token_role_attribute_provider.html">CUDSAML20CommonTokenRoleAttributeProvider</a>;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keyword">import</span> <a class="code" href="../../d6/d63/namespaceru.html">ru</a>.<a class="code" href="../../d6/d49/namespaceru_1_1spb.html">spb</a>.<a class="code" href="../../db/dae/namespaceru_1_1spb_1_1iac.html">iac</a>.<a class="code" href="../../d1/df1/namespaceru_1_1spb_1_1iac_1_1cud.html">cud</a>.<a class="code" href="../../d7/dd8/namespaceru_1_1spb_1_1iac_1_1cud_1_1util.html">util</a>.<a class="code" href="../../d9/dfc/classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal.html">CudPrincipal</a>;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html">   54</a></span>&#160; <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html">CUDSAML20TokenProvider</a> <span class="keyword">extends</span> AbstractSecurityTokenProvider</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        implements SecurityTokenProvider {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a5411903f749eddffdee3d553fb7c3bca">   57</a></span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PicketLinkLogger <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a5411903f749eddffdee3d553fb7c3bca">LOGGER</a> = PicketLinkLoggerFactory</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;            .getLogger();</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#af40f5dbb6181c7bd4a5e3f6a9d83c41e">   60</a></span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#af40f5dbb6181c7bd4a5e3f6a9d83c41e">LOGGERSLF4J</a> = LoggerFactory</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;            .getLogger(<a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html">CUDSAML20TokenProvider</a>.class);</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#ac705887d59b1f07a407a210c92217ab1">   63</a></span>&#160;    <span class="keyword">private</span> SAML20TokenAttributeProvider <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#ac705887d59b1f07a407a210c92217ab1">attributeProvider</a>;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a4fe6e168e7ad9911f687a81bdc9c51fe">   65</a></span>&#160;    <span class="keyword">private</span> <span class="keywordtype">boolean</span> <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a4fe6e168e7ad9911f687a81bdc9c51fe">useAbsoluteKeyIdentifier</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">     * (non-Javadoc)</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment">     * @see</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">     * #initialize(java.util.Map)</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00074"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a95e4dc39ec81e5c8d8e413ed70623e9c">   74</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a95e4dc39ec81e5c8d8e413ed70623e9c">initialize</a>(Map&lt;String, String&gt; properties) {</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        super.initialize(properties);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;         </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        <span class="comment">// Check if an attribute provider has been set.</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        String attributeProviderClassName = this.properties</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                .get(ATTRIBUTE_PROVIDER);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        <span class="keywordflow">if</span> (attributeProviderClassName == null) {</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            LOGGER.trace(<span class="stringliteral">&quot;No attribute provider set&quot;</span>);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                Class&lt;?&gt; clazz = <a class="code" href="../../d0/d16/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_security_actions.html">SecurityActions</a>.<a class="code" href="../../d0/d16/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_security_actions.html#ae8ba0c95fce44572318718f8bcc3eb81">loadClass</a>(getClass(),</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                        attributeProviderClassName);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                Object <span class="keywordtype">object</span> = clazz.newInstance();</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                <span class="keywordflow">if</span> (<span class="keywordtype">object</span> instanceof SAML20TokenAttributeProvider) {</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                    this.attributeProvider = (SAML20TokenAttributeProvider) <span class="keywordtype">object</span>;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                    this.attributeProvider.setProperties(this.properties);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                    LOGGER.stsWrongAttributeProviderTypeNotInstalled(attributeProviderClassName);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                }</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            } <span class="keywordflow">catch</span> (Exception pae) {</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                LOGGER.attributeProviderInstationError(pae);</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;            }</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        }</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        String absoluteKI = this.properties.get(USE_ABSOLUTE_KEYIDENTIFIER);</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        <span class="keywordflow">if</span> (absoluteKI != null &amp;&amp; <span class="stringliteral">&quot;true&quot;</span>.equalsIgnoreCase(absoluteKI)) {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;            useAbsoluteKeyIdentifier = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    }</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">     * (non-Javadoc)</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">     * @see</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">     * cancelToken</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00114"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#ade5c20c9b1d8f6f7adfc95be56cff67f">  114</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#ade5c20c9b1d8f6f7adfc95be56cff67f">cancelToken</a>(ProtocolContext protoContext)</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            <span class="keywordflow">throws</span> ProcessingException {</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="keywordflow">if</span> (!(protoContext instanceof WSTrustRequestContext)) {</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="comment">// get the assertion that must be canceled.</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        Element token = context.getRequestSecurityToken()</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                .getCancelTargetElement();</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <span class="keywordflow">if</span> (token == null) {</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            <span class="keywordflow">throw</span> LOGGER.wsTrustNullCancelTargetError();</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        }</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        Element assertionElement = (Element) token.getFirstChild();</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keywordflow">if</span> (!this.<a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#aa774cd699193c4c7aba221f105bd95c2">isAssertion</a>(assertionElement)) {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            <span class="keywordflow">throw</span> LOGGER.assertionInvalidError();</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        }</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="comment">// get the assertion ID and add it to the canceled assertions set.</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        String assertionId = assertionElement.getAttribute(<span class="stringliteral">&quot;ID&quot;</span>);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        this.revocationRegistry.revokeToken(SAMLUtil.SAML2_TOKEN_TYPE,</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                assertionId);</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    }</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">     * (non-Javadoc)</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">     * @see</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">     * issueToken</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00147"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a70c89e2240b2652f4e5c9de24a505403">  147</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a70c89e2240b2652f4e5c9de24a505403">issueToken</a>(ProtocolContext protoContext)</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            <span class="keywordflow">throws</span> ProcessingException {</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;         </div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordflow">if</span> (!(protoContext instanceof WSTrustRequestContext)) {</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        }</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        <span class="comment">// generate an id for the new assertion.</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        String assertionID = IDGenerator.create(<span class="stringliteral">&quot;ID_&quot;</span>);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <span class="comment">// lifetime and audience restrictions.</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        Lifetime lifetime = context.getRequestSecurityToken().getLifetime();</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        AudienceRestrictionType restriction = null;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        AppliesTo appliesTo = context.getRequestSecurityToken().getAppliesTo();</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keywordflow">if</span> (appliesTo != null) {</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            restriction = SAMLAssertionFactory</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                    .createAudienceRestriction(WSTrustUtil</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                            .parseAppliesTo(appliesTo));</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        }</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        ConditionsType conditions = SAMLAssertionFactory.createConditions(</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                lifetime.getCreated(), lifetime.getExpires(), restriction);</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <span class="comment">// the assertion principal (default is caller principal)</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        Principal principal = context.getCallerPrincipal();</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        String confirmationMethod = null;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        KeyInfoConfirmationDataType keyInfoDataType = null;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="comment">// if there is a on-behalf-of principal, we have the sender vouches</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="comment">// confirmation method.</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <span class="keywordflow">if</span> (context.getOnBehalfOfPrincipal() != null) {</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="comment">// principal = context.getOnBehalfOfPrincipal();</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">             * // правильно закомментировано - // user_principal уже установлен</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">             * в TestServerCryptoSOAPHandlerTransform2Sign:</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">             * if(user_obo_principal!=null){</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">             * http_session.setAttribute(&quot;user_principal&quot;, user _obo_principal);</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;            confirmationMethod = SAMLUtil.SAML2_SENDER_VOUCHES_URI;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        }</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="comment">// if there is a proof-of-possession token in the context, we have the</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="comment">// holder of key confirmation method.</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (context.getProofTokenInfo() != null) {</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            confirmationMethod = SAMLUtil.SAML2_HOLDER_OF_KEY_URI;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;            keyInfoDataType = SAMLAssertionFactory</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                    .createKeyInfoConfirmation(context.getProofTokenInfo());</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;            confirmationMethod = SAMLUtil.SAML2_BEARER_URI;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        }</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        SubjectConfirmationType subjectConfirmation = SAMLAssertionFactory</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                .createSubjectConfirmation(null, confirmationMethod,</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                        keyInfoDataType);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="comment">// create a subject using the caller principal or on-behalf-of</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="comment">// principal.</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        String subjectName = principal == null ? <span class="stringliteral">&quot;ANONYMOUS&quot;</span> : principal</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                .getName();</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        NameIDType nameID = SAMLAssertionFactory.createNameID(null,</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                <span class="stringliteral">&quot;urn:picketlink:identity-federation&quot;</span>, subjectName);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        SubjectType subject = SAMLAssertionFactory.createSubject(nameID,</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                subjectConfirmation);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        List&lt;StatementAbstractType&gt; statements = <span class="keyword">new</span> ArrayList&lt;StatementAbstractType&gt;();</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="comment">// create the attribute statements if necessary.</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        Map&lt;String, Object&gt; claimedAttributes = context.getClaimedAttributes();</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="keywordflow">if</span> (claimedAttributes != null) {</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            statements.add(StatementUtil</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                    .createAttributeStatement(claimedAttributes));</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        }</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="comment">// create an AuthnStatement</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <span class="keywordflow">if</span>(((<a class="code" href="../../d9/dfc/classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal.html">CudPrincipal</a>) principal).getUserName()!=null){</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            </div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;             <span class="comment">//для пользователей и onBehalfOf</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            confirmationMethod=(((<a class="code" href="../../d9/dfc/classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal.html">CudPrincipal</a>) principal).getAuthType()!=null?</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                    ((<a class="code" href="../../d9/dfc/classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal.html">CudPrincipal</a>) principal).getAuthType():</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                        JBossSAMLURIConstants.AC_PASSWORD.get());</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        }</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        </div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        statements.add(StatementUtil.createAuthnStatement(</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                lifetime.getCreated(), confirmationMethod));</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        </div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="comment">// create the SAML assertion.</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        NameIDType issuerID = SAMLAssertionFactory.createNameID(null, null,</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                context.getTokenIssuer());</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        AssertionType assertion = SAMLAssertionFactory.createAssertion(</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                assertionID, issuerID, lifetime.getCreated(), conditions,</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                subject, statements);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        <span class="keywordflow">if</span> (this.attributeProvider != null) {</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;             </div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;            Map&lt;String, String&gt; properties = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            <span class="comment">// if(principal instanceof CudPrincipal) {</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;            <span class="comment">// используем</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            <span class="comment">// ((CudPrincipal)principal).setUserName(context.getOnBehalfOfPrincipal().getName());</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            <span class="comment">// закомментировали properties.put(&quot;...Code&quot;)</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            <span class="comment">// 25.06.14 из-за не параллельности обработки запроса.</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;            <span class="comment">// CUDSAML20TokenProvider - один объект</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;            <span class="comment">// а значит и this.attributeProvider - будет один объект</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            <span class="comment">// первый пользователь установит properties.put(userCode1)</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            <span class="comment">// дойдёт до attributeProvider.getAttributeStatement()</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            <span class="comment">// в это время второй пользователь установит           // properties.put(userCode2)
            // и в этот момент в методе getAttributeStatement() для запроса
            // первого пользователя
            // userCode будет равен userCode2.

            /*
             * properties.put(&quot;systemCode&quot;,
             * ((CudPrincipal)principal).getSystemName());
             * properties.put(&quot;userCode&quot;,
             * ((CudPrincipal)principal).getUserName());
             */String lifetimeMs = Long.toString(lifetime.getExpires()
                    .toGregorianCalendar().getTimeInMillis());
            /*
             * properties.put(&quot;lifetimeMs&quot;, lifetimeMs);
             */

            /*
             * }else{ //principal на пользователя берётся из OnBehalfOf
             * //создаётся в GOSTStandardRequestHandler-&gt; //Principal
             * onBehalfOfPrincipal =
             * WSTrustUtil.getOnBehalfOfPrincipal(request.getOnBehalfOf());-&gt;
             * //return new Principal(username) {...}
             * 
             * properties.put(&quot;userCode&quot;, principal.getName());
             * 
             * }
             */

            this.attributeProvider.setProperties(properties);

            // AttributeStatementType attributeStatement =
            // this.attributeProvider.getAttributeStatement();
            AttributeStatementType attributeStatement = ((CUDSAML20CommonTokenRoleAttributeProvider) this.attributeProvider)
                    .getAttributeStatement(
                            ((CudPrincipal) principal).getSystemName(),
                            ((CudPrincipal) principal).getUserName(),
                            ((CudPrincipal) principal).getAuthType(),
                            lifetimeMs);

            if (attributeStatement != null) {

                 

                assertion.addStatement(attributeStatement);
            }
            
            //уже есть выше реализация
            /*
            try{
            XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();
            
            org.picketlink.identity.federation.saml.v2.assertion.AuthnStatementType ant =
                    new org.picketlink.identity.federation.saml.v2.assertion.AuthnStatementType(currentTime);
            
            AuthnContextType act = new AuthnContextType();
            
            String authContextDeclRef = 
                    (((CudPrincipal) principal).getAuthType()!=null?
                        ((CudPrincipal) principal).getAuthType():
                            JBossSAMLURIConstants.AC_PASSWORD.get());
            
            AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();
            
            AuthnContextClassRefType classRef = new AuthnContextClassRefType(URI.create(authContextDeclRef));
            sequence.setClassRef(classRef);
            act.setSequence(sequence); 
             
            ant.setAuthnContext(act);
            
            assertion.addStatement(ant);
            
            }catch(Exception e){
                 LOGGERSLF4J.error(&quot;issueToken:currentTime:error:&quot;+e);
            }*/
        }

         

        // convert the constructed assertion to element.
        Element assertionElement = null;
        try {
            assertionElement = SAMLUtil.toElement(assertion);
        } catch (Exception e) {
            throw LOGGER.samlAssertionMarshallError(e);
        }

        SecurityToken token = new StandardSecurityToken(context
                .getRequestSecurityToken().getTokenType().toString(),
                assertionElement, assertionID);
        context.setSecurityToken(token);

        // set the SAML assertion attached reference.
        String keyIdentifierValue = assertionID;
        if (!useAbsoluteKeyIdentifier) {
            keyIdentifierValue = &quot;#&quot; + keyIdentifierValue;
        }
        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(
                SAMLUtil.SAML2_VALUE_TYPE, keyIdentifierValue);
        Map&lt;QName, String&gt; attributes = new HashMap&lt;QName, String&gt;();
        attributes.put(new QName(WSTrustConstants.WSSE11_NS, &quot;TokenType&quot;,
                WSTrustConstants.WSSE.PREFIX_11), SAMLUtil.SAML2_TOKEN_TYPE);
        RequestedReferenceType attachedReference = WSTrustUtil
                .createRequestedReference(keyIdentifier, attributes);
        context.setAttachedReference(attachedReference);
    }

    /*
     * (non-Javadoc)
     * 
     * @see
     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#
     * renewToken
     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)
     */
    public void renewToken(ProtocolContext protoContext)
            throws ProcessingException {
        if (!(protoContext instanceof WSTrustRequestContext)) {
            return;
        }

        // в renewToken Subject переписывается из старого токена

        LOGGERSLF4J.debug(&quot;renewToken:01&quot;);

        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;
        // get the specified assertion that must be renewed.
        Element token = context.getRequestSecurityToken()
                .getRenewTargetElement();
        if (token == null) {
            throw LOGGER.wsTrustNullRenewTargetError();
        }
        Element oldAssertionElement = (Element) token.getFirstChild();
        if (!this.isAssertion(oldAssertionElement)) {
            throw LOGGER.assertionInvalidError();
        }

        // get the JAXB representation of the old assertion.
        AssertionType oldAssertion = null;
        try {
            oldAssertion = SAMLUtil.fromElement(oldAssertionElement);
        } catch (Exception je) {
            throw LOGGER.samlAssertionUnmarshallError(je);
        }

        // поддержка HOK
        // надо учитывать что HOK только на систему
     // а у нас токены могут быть на пользователя
        // при этом если токен от IDP, то в нём передаётся
        // &lt;saml:Subject&gt;/&lt;saml:SubjectConfirmation&gt;/&lt;saml:SubjectConfirmationData&gt;
        // тогда как в токене от STS только
        // &lt;saml:Subject&gt;/&lt;saml:SubjectConfirmation&gt;
        // а в
       // org.picketlink.identity.federation.core.saml.v2.writers.BaseWriter
        // есть проверка
        // if (subjectConfirmationData != null) {
        // write(subjectConfirmationData); }
        // где в свою очередь будет искаться
        // KeyInfoConfirmationDataType
        // который может здесь установиться
        // sct.setSubjectConfirmationData(KeyInfoConfirmationDataType type);
        // а в нём будет искаться /KeyInfoType
        // но его в токене от IDP нет, поэтому возможно исключение

        // итог
        // для токена от IDP не устанавливать
       // sct.setSubjectConfirmationData(type);
        // токен от IDP определяется условием scdt.getAnyType()==null

        SubjectConfirmationType sct = oldAssertion.getSubject()
                .getConfirmation().get(0);

        SubjectConfirmationDataType scdt = sct.getSubjectConfirmationData();

        if (scdt != null &amp;&amp; scdt.getAnyType() != null) {
            KeyInfoConfirmationDataType type = new KeyInfoConfirmationDataType();
            type.setAnyType(scdt.getAnyType());

            sct.setSubjectConfirmationData(type);
        }

        // canceled assertions cannot be renewed.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                oldAssertion.getID())) {
            throw LOGGER
                    .samlAssertionRevokedCouldNotRenew(oldAssertion.getID());
        }

        // adjust the lifetime for the renewed assertion.
        ConditionsType conditions = oldAssertion.getConditions();
        conditions.setNotBefore(context.getRequestSecurityToken().getLifetime()
                .getCreated());
        conditions.setNotOnOrAfter(context.getRequestSecurityToken()
                .getLifetime().getExpires());

        // create a new unique ID for the renewed assertion.
        String assertionID = IDGenerator.create(&quot;ID_&quot;);

        // !!!
        Principal principal = context.getCallerPrincipal();
         
        java.util.Set&lt;StatementAbstractType&gt; oldStatements = oldAssertion
                .getStatements();

        AttributeType tokenIDAttribute = null;
        String uidAttribute = null;

        for (StatementAbstractType oldSt : oldStatements) {
            if (oldSt instanceof AttributeStatementType) {
                for (org.picketlink.identity.federation.saml.v2.assertion.AttributeStatementType.ASTChoiceType atr : ((AttributeStatementType) oldSt)
                        .getAttributes()) {
                    if (&quot;TOKEN_ID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:02:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        tokenIDAttribute = atr.getAttribute();

                    } else if (&quot;USER_UID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:03:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        uidAttribute = (String) atr.getAttribute()
                                .getAttributeValue().get(0);
                    }
                }
            }/*else if(oldSt instanceof AuthnStatementType){
                
            //впринципе, сам sts не продляет AuthnInstant у saml:AuthnStatement при renew
            //так что и мы не будем	
            //то есть, saml:AuthnStatement переносится какой есть.   
            try{    
                
                URI authContextDeclRef = null;
                Set&lt;URI&gt; list = ((AuthnStatementType) oldSt).getAuthnContext().getAuthenticatingAuthority();
                        
                if(list!=null &amp;&amp;!list.isEmpty()){
                    authContextDeclRef = list.iterator().next() ;   
                }
                
                XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();
                oldSt = new AuthnStatementType(currentTime);
            
                AuthnContextType act = new AuthnContextType();
                
                AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();
                
                AuthnContextClassRefType classRef = new AuthnContextClassRefType(
                        authContextDeclRef!=null?
                                authContextDeclRef:
                                URI.create(JBossSAMLURIConstants.AC_PASSWORD.get()));
                sequence.setClassRef(classRef);
                act.setSequence(sequence); 
            
                     
                ((AuthnStatementType)oldSt).setAuthnContext(act);
            
                
            } catch (Exception e) {
                 LOGGERSLF4J.error(&quot;renewToken:currentTime:error:&quot;+e);
            }

            }*/
        }

        LOGGERSLF4J.debug(&quot;renewToken:04&quot;);

        if (tokenIDAttribute != null) {
            if (tokenIDAttribute.getAttributeValue() != null) {
                tokenIDAttribute.removeAttributeValue(tokenIDAttribute
                        .getAttributeValue().get(0));
            }

            String lifetimeMs = Long.toString(context.getRequestSecurityToken()
                    .getLifetime().getExpires().toGregorianCalendar()
                    .getTimeInMillis());

            tokenIDAttribute
                    .addAttributeValue(new CUDSAML20CommonTokenRoleAttributeProvider()
                            .tokenIDCreate(uidAttribute, ((CudPrincipal)principal).getAuthType(), lifetimeMs));
        }

        List&lt;StatementAbstractType&gt; statements = new ArrayList&lt;StatementAbstractType&gt;();
        statements.addAll(oldAssertion.getStatements());

        // create the new assertion.
        AssertionType newAssertion = SAMLAssertionFactory.createAssertion(
                assertionID, oldAssertion.getIssuer(), context
                        .getRequestSecurityToken().getLifetime().getCreated(),
                conditions, oldAssertion.getSubject(), statements);

        // create a security token with the new assertion.
        Element assertionElement = null;
        try {
            assertionElement = SAMLUtil.toElement(newAssertion);
        } catch (Exception e) {
            throw LOGGER.samlAssertionMarshallError(e);
        }

        LOGGERSLF4J.debug(&quot;renewToken:02++&quot;);

        SecurityToken securityToken = new StandardSecurityToken(context
                .getRequestSecurityToken().getTokenType().toString(),
                assertionElement, assertionID);
        context.setSecurityToken(securityToken);

        // set the SAML assertion attached reference.
        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(
                SAMLUtil.SAML2_VALUE_TYPE, &quot;#&quot; + assertionID);
        Map&lt;QName, String&gt; attributes = new HashMap&lt;QName, String&gt;();
        attributes.put(new QName(WSTrustConstants.WSSE11_NS, &quot;TokenType&quot;),
                SAMLUtil.SAML2_TOKEN_TYPE);
        RequestedReferenceType attachedReference = WSTrustUtil
                .createRequestedReference(keyIdentifier, attributes);
        context.setAttachedReference(attachedReference);
    }

    /*
     * (non-Javadoc)
     * 
     * @see
     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#
     * validateToken
     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)
     */
    public void validateToken(ProtocolContext protoContext)
            throws ProcessingException {
        if (!(protoContext instanceof WSTrustRequestContext)) {
            return;
        }

        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;

        LOGGER.trace(&quot;SAML token validation started&quot;);

        // get the SAML assertion that must be validated.
        Element token = context.getRequestSecurityToken()
                .getValidateTargetElement();
        if (token == null) {
            throw LOGGER.wsTrustNullValidationTargetError();
        }

        String code = WSTrustConstants.STATUS_CODE_VALID;
        String reason = &quot;SAMLV2.0 Assertion successfuly validated&quot;;

        AssertionType assertion = null;
        Element assertionElement = (Element) token.getFirstChild();
        if (!this.isAssertion(assertionElement)) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: supplied token is not a SAMLV2.0 Assertion&quot;;
        } else {
            try {
                if (LOGGER.isTraceEnabled()) {
                    LOGGER.samlAssertion(DocumentUtil
                            .getNodeAsString(assertionElement));
                }
                assertion = SAMLUtil.fromElement(assertionElement);
            } catch (Exception e) {
                throw LOGGER.samlAssertionUnmarshallError(e);
            }
        }

        // check if the assertion has been canceled before.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                assertion.getID())) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: assertion with id &quot;
                    + assertion.getID() + &quot; has been canceled&quot;;
        }

        // check the assertion lifetime.
        try {
            if (AssertionUtil.hasExpired(assertion)) {
                code = WSTrustConstants.STATUS_CODE_INVALID;
                reason = &quot;Validation failure: assertion expired or used before its lifetime period&quot;;
            }
        } catch (Exception ce) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: unable to verify assertion lifetime: &quot;
                    + ce.getMessage();
        }

        // construct the status and set it on the request context.
        StatusType status = new StatusType();
        status.setCode(code);
        status.setReason(reason);
        context.setStatus(status);
    }

    /**
     * &lt;p&gt;
     * Checks whether the specified element is a SAMLV2.0 assertion or not.
     * &lt;/p&gt;
     * 
     * @param element
     *            the {@code Element} being verified.
     * @return {@code true} if the element is a SAMLV2.0 assertion;
     *         {@code false} otherwise.
     */
    private boolean isAssertion(Element element) {
        return element == null ? false : &quot;Assertion&quot;.equals(element
                .getLocalName())
                &amp;&amp; WSTrustConstants.SAML2_ASSERTION_NS.equals(element
                        .getNamespaceURI());
    }

    /**
     * @see {@code SecurityTokenProvider#supports(String)}
     */
    public boolean supports(String namespace) {
        return WSTrustConstants.BASE_NAMESPACE.equals(namespace);
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#tokenType()
     */
    public String tokenType() {
        return SAMLUtil.SAML2_TOKEN_TYPE;
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#getSupportedQName()
     */
    public QName getSupportedQName() {
        return new QName(tokenType(), JBossSAMLConstants.ASSERTION.get());
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#family()
     */
    public String family() {
        return SecurityTokenProvider.FAMILY_TYPE.WS_TRUST.toString();
    }
}</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;            <span class="comment">// properties.put(userCode2)</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;            <span class="comment">// и в этот момент в методе getAttributeStatement() для запроса             // первого пользователя
            // userCode будет равен userCode2.

            /*
             * properties.put(&quot;systemCode&quot;,
             * ((CudPrincipal)principal).getSystemName());
             * properties.put(&quot;userCode&quot;,
             * ((CudPrincipal)principal).getUserName());
             */String lifetimeMs = Long.toString(lifetime.getExpires()
                    .toGregorianCalendar().getTimeInMillis());
            /*
             * properties.put(&quot;lifetimeMs&quot;, lifetimeMs);
             */

            /*
             * }else{ //principal на пользователя берётся из OnBehalfOf
             * //создаётся в GOSTStandardRequestHandler-&gt; //Principal
             * onBehalfOfPrincipal =
             * WSTrustUtil.getOnBehalfOfPrincipal(request.getOnBehalfOf());-&gt;
             * //return new Principal(username) {...}
             * 
             * properties.put(&quot;userCode&quot;, principal.getName());
             * 
             * }
             */

            this.attributeProvider.setProperties(properties);

            // AttributeStatementType attributeStatement =
            // this.attributeProvider.getAttributeStatement();
            AttributeStatementType attributeStatement = ((CUDSAML20CommonTokenRoleAttributeProvider) this.attributeProvider)
                    .getAttributeStatement(
                            ((CudPrincipal) principal).getSystemName(),
                            ((CudPrincipal) principal).getUserName(),
                            ((CudPrincipal) principal).getAuthType(),
                            lifetimeMs);

            if (attributeStatement != null) {

                 

                assertion.addStatement(attributeStatement);
            }
            
            //уже есть выше реализация
            /*
            try{
            XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();
            
            org.picketlink.identity.federation.saml.v2.assertion.AuthnStatementType ant =
                    new org.picketlink.identity.federation.saml.v2.assertion.AuthnStatementType(currentTime);
            
            AuthnContextType act = new AuthnContextType();
            
            String authContextDeclRef = 
                    (((CudPrincipal) principal).getAuthType()!=null?
                        ((CudPrincipal) principal).getAuthType():
                            JBossSAMLURIConstants.AC_PASSWORD.get());
            
            AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();
            
            AuthnContextClassRefType classRef = new AuthnContextClassRefType(URI.create(authContextDeclRef));
            sequence.setClassRef(classRef);
            act.setSequence(sequence); 
             
            ant.setAuthnContext(act);
            
            assertion.addStatement(ant);
            
            }catch(Exception e){
                 LOGGERSLF4J.error(&quot;issueToken:currentTime:error:&quot;+e);
            }*/
        }

         

        // convert the constructed assertion to element.
        Element assertionElement = null;
        try {
            assertionElement = SAMLUtil.toElement(assertion);
        } catch (Exception e) {
            throw LOGGER.samlAssertionMarshallError(e);
        }

        SecurityToken token = new StandardSecurityToken(context
                .getRequestSecurityToken().getTokenType().toString(),
                assertionElement, assertionID);
        context.setSecurityToken(token);

        // set the SAML assertion attached reference.
        String keyIdentifierValue = assertionID;
        if (!useAbsoluteKeyIdentifier) {
            keyIdentifierValue = &quot;#&quot; + keyIdentifierValue;
        }
        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(
                SAMLUtil.SAML2_VALUE_TYPE, keyIdentifierValue);
        Map&lt;QName, String&gt; attributes = new HashMap&lt;QName, String&gt;();
        attributes.put(new QName(WSTrustConstants.WSSE11_NS, &quot;TokenType&quot;,
                WSTrustConstants.WSSE.PREFIX_11), SAMLUtil.SAML2_TOKEN_TYPE);
        RequestedReferenceType attachedReference = WSTrustUtil
                .createRequestedReference(keyIdentifier, attributes);
        context.setAttachedReference(attachedReference);
    }

    /*
     * (non-Javadoc)
     * 
     * @see
     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#
     * renewToken
     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)
     */
    public void renewToken(ProtocolContext protoContext)
            throws ProcessingException {
        if (!(protoContext instanceof WSTrustRequestContext)) {
            return;
        }

        // в renewToken Subject переписывается из старого токена

        LOGGERSLF4J.debug(&quot;renewToken:01&quot;);

        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;
        // get the specified assertion that must be renewed.
        Element token = context.getRequestSecurityToken()
                .getRenewTargetElement();
        if (token == null) {
            throw LOGGER.wsTrustNullRenewTargetError();
        }
        Element oldAssertionElement = (Element) token.getFirstChild();
        if (!this.isAssertion(oldAssertionElement)) {
            throw LOGGER.assertionInvalidError();
        }

        // get the JAXB representation of the old assertion.
        AssertionType oldAssertion = null;
        try {
            oldAssertion = SAMLUtil.fromElement(oldAssertionElement);
        } catch (Exception je) {
            throw LOGGER.samlAssertionUnmarshallError(je);
        }

        // поддержка HOK
        // надо учитывать что HOK только на систему
     // а у нас токены могут быть на пользователя
        // при этом если токен от IDP, то в нём передаётся
        // &lt;saml:Subject&gt;/&lt;saml:SubjectConfirmation&gt;/&lt;saml:SubjectConfirmationData&gt;
        // тогда как в токене от STS только
        // &lt;saml:Subject&gt;/&lt;saml:SubjectConfirmation&gt;
        // а в
       // org.picketlink.identity.federation.core.saml.v2.writers.BaseWriter
        // есть проверка
        // if (subjectConfirmationData != null) {
        // write(subjectConfirmationData); }
        // где в свою очередь будет искаться
        // KeyInfoConfirmationDataType
        // который может здесь установиться
        // sct.setSubjectConfirmationData(KeyInfoConfirmationDataType type);
        // а в нём будет искаться /KeyInfoType
        // но его в токене от IDP нет, поэтому возможно исключение

        // итог
        // для токена от IDP не устанавливать
       // sct.setSubjectConfirmationData(type);
        // токен от IDP определяется условием scdt.getAnyType()==null

        SubjectConfirmationType sct = oldAssertion.getSubject()
                .getConfirmation().get(0);

        SubjectConfirmationDataType scdt = sct.getSubjectConfirmationData();

        if (scdt != null &amp;&amp; scdt.getAnyType() != null) {
            KeyInfoConfirmationDataType type = new KeyInfoConfirmationDataType();
            type.setAnyType(scdt.getAnyType());

            sct.setSubjectConfirmationData(type);
        }

        // canceled assertions cannot be renewed.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                oldAssertion.getID())) {
            throw LOGGER
                    .samlAssertionRevokedCouldNotRenew(oldAssertion.getID());
        }

        // adjust the lifetime for the renewed assertion.
        ConditionsType conditions = oldAssertion.getConditions();
        conditions.setNotBefore(context.getRequestSecurityToken().getLifetime()
                .getCreated());
        conditions.setNotOnOrAfter(context.getRequestSecurityToken()
                .getLifetime().getExpires());

        // create a new unique ID for the renewed assertion.
        String assertionID = IDGenerator.create(&quot;ID_&quot;);

        // !!!
        Principal principal = context.getCallerPrincipal();
         
        java.util.Set&lt;StatementAbstractType&gt; oldStatements = oldAssertion
                .getStatements();

        AttributeType tokenIDAttribute = null;
        String uidAttribute = null;

        for (StatementAbstractType oldSt : oldStatements) {
            if (oldSt instanceof AttributeStatementType) {
                for (org.picketlink.identity.federation.saml.v2.assertion.AttributeStatementType.ASTChoiceType atr : ((AttributeStatementType) oldSt)
                        .getAttributes()) {
                    if (&quot;TOKEN_ID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:02:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        tokenIDAttribute = atr.getAttribute();

                    } else if (&quot;USER_UID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:03:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        uidAttribute = (String) atr.getAttribute()
                                .getAttributeValue().get(0);
                    }
                }
            }/*else if(oldSt instanceof AuthnStatementType){
                
            //впринципе, сам sts не продляет AuthnInstant у saml:AuthnStatement при renew
            //так что и мы не будем	
            //то есть, saml:AuthnStatement переносится какой есть.   
            try{    
                
                URI authContextDeclRef = null;
                Set&lt;URI&gt; list = ((AuthnStatementType) oldSt).getAuthnContext().getAuthenticatingAuthority();
                        
                if(list!=null &amp;&amp;!list.isEmpty()){
                    authContextDeclRef = list.iterator().next() ;   
                }
                
                XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();
                oldSt = new AuthnStatementType(currentTime);
            
                AuthnContextType act = new AuthnContextType();
                
                AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();
                
                AuthnContextClassRefType classRef = new AuthnContextClassRefType(
                        authContextDeclRef!=null?
                                authContextDeclRef:
                                URI.create(JBossSAMLURIConstants.AC_PASSWORD.get()));
                sequence.setClassRef(classRef);
                act.setSequence(sequence); 
            
                     
                ((AuthnStatementType)oldSt).setAuthnContext(act);
            
                
            } catch (Exception e) {
                 LOGGERSLF4J.error(&quot;renewToken:currentTime:error:&quot;+e);
            }

            }*/
        }

        LOGGERSLF4J.debug(&quot;renewToken:04&quot;);

        if (tokenIDAttribute != null) {
            if (tokenIDAttribute.getAttributeValue() != null) {
                tokenIDAttribute.removeAttributeValue(tokenIDAttribute
                        .getAttributeValue().get(0));
            }

            String lifetimeMs = Long.toString(context.getRequestSecurityToken()
                    .getLifetime().getExpires().toGregorianCalendar()
                    .getTimeInMillis());

            tokenIDAttribute
                    .addAttributeValue(new CUDSAML20CommonTokenRoleAttributeProvider()
                            .tokenIDCreate(uidAttribute, ((CudPrincipal)principal).getAuthType(), lifetimeMs));
        }

        List&lt;StatementAbstractType&gt; statements = new ArrayList&lt;StatementAbstractType&gt;();
        statements.addAll(oldAssertion.getStatements());

        // create the new assertion.
        AssertionType newAssertion = SAMLAssertionFactory.createAssertion(
                assertionID, oldAssertion.getIssuer(), context
                        .getRequestSecurityToken().getLifetime().getCreated(),
                conditions, oldAssertion.getSubject(), statements);

        // create a security token with the new assertion.
        Element assertionElement = null;
        try {
            assertionElement = SAMLUtil.toElement(newAssertion);
        } catch (Exception e) {
            throw LOGGER.samlAssertionMarshallError(e);
        }

        LOGGERSLF4J.debug(&quot;renewToken:02++&quot;);

        SecurityToken securityToken = new StandardSecurityToken(context
                .getRequestSecurityToken().getTokenType().toString(),
                assertionElement, assertionID);
        context.setSecurityToken(securityToken);

        // set the SAML assertion attached reference.
        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(
                SAMLUtil.SAML2_VALUE_TYPE, &quot;#&quot; + assertionID);
        Map&lt;QName, String&gt; attributes = new HashMap&lt;QName, String&gt;();
        attributes.put(new QName(WSTrustConstants.WSSE11_NS, &quot;TokenType&quot;),
                SAMLUtil.SAML2_TOKEN_TYPE);
        RequestedReferenceType attachedReference = WSTrustUtil
                .createRequestedReference(keyIdentifier, attributes);
        context.setAttachedReference(attachedReference);
    }

    /*
     * (non-Javadoc)
     * 
     * @see
     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#
     * validateToken
     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)
     */
    public void validateToken(ProtocolContext protoContext)
            throws ProcessingException {
        if (!(protoContext instanceof WSTrustRequestContext)) {
            return;
        }

        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;

        LOGGER.trace(&quot;SAML token validation started&quot;);

        // get the SAML assertion that must be validated.
        Element token = context.getRequestSecurityToken()
                .getValidateTargetElement();
        if (token == null) {
            throw LOGGER.wsTrustNullValidationTargetError();
        }

        String code = WSTrustConstants.STATUS_CODE_VALID;
        String reason = &quot;SAMLV2.0 Assertion successfuly validated&quot;;

        AssertionType assertion = null;
        Element assertionElement = (Element) token.getFirstChild();
        if (!this.isAssertion(assertionElement)) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: supplied token is not a SAMLV2.0 Assertion&quot;;
        } else {
            try {
                if (LOGGER.isTraceEnabled()) {
                    LOGGER.samlAssertion(DocumentUtil
                            .getNodeAsString(assertionElement));
                }
                assertion = SAMLUtil.fromElement(assertionElement);
            } catch (Exception e) {
                throw LOGGER.samlAssertionUnmarshallError(e);
            }
        }

        // check if the assertion has been canceled before.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                assertion.getID())) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: assertion with id &quot;
                    + assertion.getID() + &quot; has been canceled&quot;;
        }

        // check the assertion lifetime.
        try {
            if (AssertionUtil.hasExpired(assertion)) {
                code = WSTrustConstants.STATUS_CODE_INVALID;
                reason = &quot;Validation failure: assertion expired or used before its lifetime period&quot;;
            }
        } catch (Exception ce) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: unable to verify assertion lifetime: &quot;
                    + ce.getMessage();
        }

        // construct the status and set it on the request context.
        StatusType status = new StatusType();
        status.setCode(code);
        status.setReason(reason);
        context.setStatus(status);
    }

    /**
     * &lt;p&gt;
     * Checks whether the specified element is a SAMLV2.0 assertion or not.
     * &lt;/p&gt;
     * 
     * @param element
     *            the {@code Element} being verified.
     * @return {@code true} if the element is a SAMLV2.0 assertion;
     *         {@code false} otherwise.
     */
    private boolean isAssertion(Element element) {
        return element == null ? false : &quot;Assertion&quot;.equals(element
                .getLocalName())
                &amp;&amp; WSTrustConstants.SAML2_ASSERTION_NS.equals(element
                        .getNamespaceURI());
    }

    /**
     * @see {@code SecurityTokenProvider#supports(String)}
     */
    public boolean supports(String namespace) {
        return WSTrustConstants.BASE_NAMESPACE.equals(namespace);
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#tokenType()
     */
    public String tokenType() {
        return SAMLUtil.SAML2_TOKEN_TYPE;
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#getSupportedQName()
     */
    public QName getSupportedQName() {
        return new QName(tokenType(), JBossSAMLConstants.ASSERTION.get());
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#family()
     */
    public String family() {
        return SecurityTokenProvider.FAMILY_TYPE.WS_TRUST.toString();
    }
}</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;            <span class="comment">// первого пользователя</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;            <span class="comment">// userCode будет равен userCode2.</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">             * properties.put(&quot;systemCode&quot;,</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">             * ((CudPrincipal)principal).getSystemName());</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">             * properties.put(&quot;userCode&quot;,</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">             * ((CudPrincipal)principal).getUserName());</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">             */</span>String lifetimeMs = Long.toString(lifetime.getExpires()</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                    .toGregorianCalendar().getTimeInMillis());</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">             * properties.put(&quot;lifetimeMs&quot;, lifetimeMs);</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">             * }else{ //principal на пользователя берётся из OnBehalfOf</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">             * //создаётся в GOSTStandardRequestHandler-&gt; //Principal</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">             * onBehalfOfPrincipal =</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">             * WSTrustUtil.getOnBehalfOfPrincipal(request.getOnBehalfOf());-&gt;</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">             * //return new Principal(username) {...}</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">             * </span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">             * properties.put(&quot;userCode&quot;, principal.getName());</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">             * </span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">             * }</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            this.attributeProvider.setProperties(properties);</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            <span class="comment">// AttributeStatementType attributeStatement =</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;            <span class="comment">// this.attributeProvider.getAttributeStatement();</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            AttributeStatementType attributeStatement = ((<a class="code" href="../../d2/dca/classru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core_1_1attrib_1_1_c_u_d_s_a_m_l20_common_token_role_attribute_provider.html">CUDSAML20CommonTokenRoleAttributeProvider</a>) this.attributeProvider)</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                    .getAttributeStatement(</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                            ((<a class="code" href="../../d9/dfc/classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal.html">CudPrincipal</a>) principal).getSystemName(),</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                            ((<a class="code" href="../../d9/dfc/classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal.html">CudPrincipal</a>) principal).getUserName(),</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                            ((<a class="code" href="../../d9/dfc/classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal.html">CudPrincipal</a>) principal).getAuthType(),</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                            lifetimeMs);</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            <span class="keywordflow">if</span> (attributeStatement != null) {</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                 </div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                assertion.addStatement(attributeStatement);</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            }</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            </div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            <span class="comment">//уже есть выше реализация</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">            try{</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">            XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">            org.picketlink.identity.federation.saml.v2.assertion.AuthnStatementType ant =</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">                    new org.picketlink.identity.federation.saml.v2.assertion.AuthnStatementType(currentTime);</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">            AuthnContextType act = new AuthnContextType();</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">            String authContextDeclRef = </span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">                    (((CudPrincipal) principal).getAuthType()!=null?</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment">                        ((CudPrincipal) principal).getAuthType():</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">                            JBossSAMLURIConstants.AC_PASSWORD.get());</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">            AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">            AuthnContextClassRefType classRef = new AuthnContextClassRefType(URI.create(authContextDeclRef));</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">            sequence.setClassRef(classRef);</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">            act.setSequence(sequence); </span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">             </span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">            ant.setAuthnContext(act);</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">            assertion.addStatement(ant);</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">            }catch(Exception e){</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">                 LOGGERSLF4J.error(&quot;issueToken:currentTime:error:&quot;+e);</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">            }*/</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        }</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;         </div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        <span class="comment">// convert the constructed assertion to element.</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        Element assertionElement = null;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            assertionElement = SAMLUtil.toElement(assertion);</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            <span class="keywordflow">throw</span> LOGGER.samlAssertionMarshallError(e);</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        }</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        SecurityToken token = <span class="keyword">new</span> StandardSecurityToken(context</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                .getRequestSecurityToken().getTokenType().toString(),</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                assertionElement, assertionID);</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        context.setSecurityToken(token);</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        <span class="comment">// set the SAML assertion attached reference.</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        String keyIdentifierValue = assertionID;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        <span class="keywordflow">if</span> (!useAbsoluteKeyIdentifier) {</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;            keyIdentifierValue = <span class="stringliteral">&quot;#&quot;</span> + keyIdentifierValue;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        }</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                SAMLUtil.SAML2_VALUE_TYPE, keyIdentifierValue);</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        Map&lt;QName, String&gt; attributes = <span class="keyword">new</span> HashMap&lt;QName, String&gt;();</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        attributes.put(<span class="keyword">new</span> QName(WSTrustConstants.WSSE11_NS, <span class="stringliteral">&quot;TokenType&quot;</span>,</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                WSTrustConstants.WSSE.PREFIX_11), SAMLUtil.SAML2_TOKEN_TYPE);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        RequestedReferenceType attachedReference = WSTrustUtil</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                .createRequestedReference(keyIdentifier, attributes);</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        context.setAttachedReference(attachedReference);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    }</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">     * (non-Javadoc)</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="comment">     * @see</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="comment">     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="comment">     * renewToken</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment">     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00378"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a54a88306d84c02eb2287b98a18ebcf96">  378</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a54a88306d84c02eb2287b98a18ebcf96">renewToken</a>(ProtocolContext protoContext)</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            <span class="keywordflow">throws</span> ProcessingException {</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        <span class="keywordflow">if</span> (!(protoContext instanceof WSTrustRequestContext)) {</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        }</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        <span class="comment">// в renewToken Subject переписывается из старого токена</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        LOGGERSLF4J.debug(<span class="stringliteral">&quot;renewToken:01&quot;</span>);</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="comment">// get the specified assertion that must be renewed.</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        Element token = context.getRequestSecurityToken()</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                .getRenewTargetElement();</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        <span class="keywordflow">if</span> (token == null) {</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;            <span class="keywordflow">throw</span> LOGGER.wsTrustNullRenewTargetError();</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        }</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        Element oldAssertionElement = (Element) token.getFirstChild();</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        <span class="keywordflow">if</span> (!this.<a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#aa774cd699193c4c7aba221f105bd95c2">isAssertion</a>(oldAssertionElement)) {</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;            <span class="keywordflow">throw</span> LOGGER.assertionInvalidError();</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        }</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="comment">// get the JAXB representation of the old assertion.</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        AssertionType oldAssertion = null;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            oldAssertion = SAMLUtil.fromElement(oldAssertionElement);</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        } <span class="keywordflow">catch</span> (Exception je) {</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            <span class="keywordflow">throw</span> LOGGER.samlAssertionUnmarshallError(je);</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        }</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        <span class="comment">// поддержка HOK</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <span class="comment">// надо учитывать что HOK только на систему      // а у нас токены могут быть на пользователя
        // при этом если токен от IDP, то в нём передаётся
        // &lt;saml:Subject&gt;/&lt;saml:SubjectConfirmation&gt;/&lt;saml:SubjectConfirmationData&gt;
        // тогда как в токене от STS только
        // &lt;saml:Subject&gt;/&lt;saml:SubjectConfirmation&gt;
        // а в
       // org.picketlink.identity.federation.core.saml.v2.writers.BaseWriter
        // есть проверка
        // if (subjectConfirmationData != null) {
        // write(subjectConfirmationData); }
        // где в свою очередь будет искаться
        // KeyInfoConfirmationDataType
        // который может здесь установиться
        // sct.setSubjectConfirmationData(KeyInfoConfirmationDataType type);
        // а в нём будет искаться /KeyInfoType
        // но его в токене от IDP нет, поэтому возможно исключение

        // итог
        // для токена от IDP не устанавливать
       // sct.setSubjectConfirmationData(type);
        // токен от IDP определяется условием scdt.getAnyType()==null

        SubjectConfirmationType sct = oldAssertion.getSubject()
                .getConfirmation().get(0);

        SubjectConfirmationDataType scdt = sct.getSubjectConfirmationData();

        if (scdt != null &amp;&amp; scdt.getAnyType() != null) {
            KeyInfoConfirmationDataType type = new KeyInfoConfirmationDataType();
            type.setAnyType(scdt.getAnyType());

            sct.setSubjectConfirmationData(type);
        }

        // canceled assertions cannot be renewed.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                oldAssertion.getID())) {
            throw LOGGER
                    .samlAssertionRevokedCouldNotRenew(oldAssertion.getID());
        }

        // adjust the lifetime for the renewed assertion.
        ConditionsType conditions = oldAssertion.getConditions();
        conditions.setNotBefore(context.getRequestSecurityToken().getLifetime()
                .getCreated());
        conditions.setNotOnOrAfter(context.getRequestSecurityToken()
                .getLifetime().getExpires());

        // create a new unique ID for the renewed assertion.
        String assertionID = IDGenerator.create(&quot;ID_&quot;);

        // !!!
        Principal principal = context.getCallerPrincipal();
         
        java.util.Set&lt;StatementAbstractType&gt; oldStatements = oldAssertion
                .getStatements();

        AttributeType tokenIDAttribute = null;
        String uidAttribute = null;

        for (StatementAbstractType oldSt : oldStatements) {
            if (oldSt instanceof AttributeStatementType) {
                for (org.picketlink.identity.federation.saml.v2.assertion.AttributeStatementType.ASTChoiceType atr : ((AttributeStatementType) oldSt)
                        .getAttributes()) {
                    if (&quot;TOKEN_ID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:02:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        tokenIDAttribute = atr.getAttribute();

                    } else if (&quot;USER_UID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:03:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        uidAttribute = (String) atr.getAttribute()
                                .getAttributeValue().get(0);
                    }
                }
            }/*else if(oldSt instanceof AuthnStatementType){
                
            //впринципе, сам sts не продляет AuthnInstant у saml:AuthnStatement при renew
            //так что и мы не будем	
            //то есть, saml:AuthnStatement переносится какой есть.   
            try{    
                
                URI authContextDeclRef = null;
                Set&lt;URI&gt; list = ((AuthnStatementType) oldSt).getAuthnContext().getAuthenticatingAuthority();
                        
                if(list!=null &amp;&amp;!list.isEmpty()){
                    authContextDeclRef = list.iterator().next() ;   
                }
                
                XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();
                oldSt = new AuthnStatementType(currentTime);
            
                AuthnContextType act = new AuthnContextType();
                
                AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();
                
                AuthnContextClassRefType classRef = new AuthnContextClassRefType(
                        authContextDeclRef!=null?
                                authContextDeclRef:
                                URI.create(JBossSAMLURIConstants.AC_PASSWORD.get()));
                sequence.setClassRef(classRef);
                act.setSequence(sequence); 
            
                     
                ((AuthnStatementType)oldSt).setAuthnContext(act);
            
                
            } catch (Exception e) {
                 LOGGERSLF4J.error(&quot;renewToken:currentTime:error:&quot;+e);
            }

            }*/
        }

        LOGGERSLF4J.debug(&quot;renewToken:04&quot;);

        if (tokenIDAttribute != null) {
            if (tokenIDAttribute.getAttributeValue() != null) {
                tokenIDAttribute.removeAttributeValue(tokenIDAttribute
                        .getAttributeValue().get(0));
            }

            String lifetimeMs = Long.toString(context.getRequestSecurityToken()
                    .getLifetime().getExpires().toGregorianCalendar()
                    .getTimeInMillis());

            tokenIDAttribute
                    .addAttributeValue(new CUDSAML20CommonTokenRoleAttributeProvider()
                            .tokenIDCreate(uidAttribute, ((CudPrincipal)principal).getAuthType(), lifetimeMs));
        }

        List&lt;StatementAbstractType&gt; statements = new ArrayList&lt;StatementAbstractType&gt;();
        statements.addAll(oldAssertion.getStatements());

        // create the new assertion.
        AssertionType newAssertion = SAMLAssertionFactory.createAssertion(
                assertionID, oldAssertion.getIssuer(), context
                        .getRequestSecurityToken().getLifetime().getCreated(),
                conditions, oldAssertion.getSubject(), statements);

        // create a security token with the new assertion.
        Element assertionElement = null;
        try {
            assertionElement = SAMLUtil.toElement(newAssertion);
        } catch (Exception e) {
            throw LOGGER.samlAssertionMarshallError(e);
        }

        LOGGERSLF4J.debug(&quot;renewToken:02++&quot;);

        SecurityToken securityToken = new StandardSecurityToken(context
                .getRequestSecurityToken().getTokenType().toString(),
                assertionElement, assertionID);
        context.setSecurityToken(securityToken);

        // set the SAML assertion attached reference.
        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(
                SAMLUtil.SAML2_VALUE_TYPE, &quot;#&quot; + assertionID);
        Map&lt;QName, String&gt; attributes = new HashMap&lt;QName, String&gt;();
        attributes.put(new QName(WSTrustConstants.WSSE11_NS, &quot;TokenType&quot;),
                SAMLUtil.SAML2_TOKEN_TYPE);
        RequestedReferenceType attachedReference = WSTrustUtil
                .createRequestedReference(keyIdentifier, attributes);
        context.setAttachedReference(attachedReference);
    }

    /*
     * (non-Javadoc)
     * 
     * @see
     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#
     * validateToken
     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)
     */
    public void validateToken(ProtocolContext protoContext)
            throws ProcessingException {
        if (!(protoContext instanceof WSTrustRequestContext)) {
            return;
        }

        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;

        LOGGER.trace(&quot;SAML token validation started&quot;);

        // get the SAML assertion that must be validated.
        Element token = context.getRequestSecurityToken()
                .getValidateTargetElement();
        if (token == null) {
            throw LOGGER.wsTrustNullValidationTargetError();
        }

        String code = WSTrustConstants.STATUS_CODE_VALID;
        String reason = &quot;SAMLV2.0 Assertion successfuly validated&quot;;

        AssertionType assertion = null;
        Element assertionElement = (Element) token.getFirstChild();
        if (!this.isAssertion(assertionElement)) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: supplied token is not a SAMLV2.0 Assertion&quot;;
        } else {
            try {
                if (LOGGER.isTraceEnabled()) {
                    LOGGER.samlAssertion(DocumentUtil
                            .getNodeAsString(assertionElement));
                }
                assertion = SAMLUtil.fromElement(assertionElement);
            } catch (Exception e) {
                throw LOGGER.samlAssertionUnmarshallError(e);
            }
        }

        // check if the assertion has been canceled before.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                assertion.getID())) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: assertion with id &quot;
                    + assertion.getID() + &quot; has been canceled&quot;;
        }

        // check the assertion lifetime.
        try {
            if (AssertionUtil.hasExpired(assertion)) {
                code = WSTrustConstants.STATUS_CODE_INVALID;
                reason = &quot;Validation failure: assertion expired or used before its lifetime period&quot;;
            }
        } catch (Exception ce) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: unable to verify assertion lifetime: &quot;
                    + ce.getMessage();
        }

        // construct the status and set it on the request context.
        StatusType status = new StatusType();
        status.setCode(code);
        status.setReason(reason);
        context.setStatus(status);
    }

    /**
     * &lt;p&gt;
     * Checks whether the specified element is a SAMLV2.0 assertion or not.
     * &lt;/p&gt;
     * 
     * @param element
     *            the {@code Element} being verified.
     * @return {@code true} if the element is a SAMLV2.0 assertion;
     *         {@code false} otherwise.
     */
    private boolean isAssertion(Element element) {
        return element == null ? false : &quot;Assertion&quot;.equals(element
                .getLocalName())
                &amp;&amp; WSTrustConstants.SAML2_ASSERTION_NS.equals(element
                        .getNamespaceURI());
    }

    /**
     * @see {@code SecurityTokenProvider#supports(String)}
     */
    public boolean supports(String namespace) {
        return WSTrustConstants.BASE_NAMESPACE.equals(namespace);
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#tokenType()
     */
    public String tokenType() {
        return SAMLUtil.SAML2_TOKEN_TYPE;
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#getSupportedQName()
     */
    public QName getSupportedQName() {
        return new QName(tokenType(), JBossSAMLConstants.ASSERTION.get());
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#family()
     */
    public String family() {
        return SecurityTokenProvider.FAMILY_TYPE.WS_TRUST.toString();
    }
}</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        <span class="comment">// а у нас токены могут быть на пользователя</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="comment">// при этом если токен от IDP, то в нём передаётся</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="comment">// &lt;saml:Subject&gt;/&lt;saml:SubjectConfirmation&gt;/&lt;saml:SubjectConfirmationData&gt;</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        <span class="comment">// тогда как в токене от STS только</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="comment">// &lt;saml:Subject&gt;/&lt;saml:SubjectConfirmation&gt;</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="comment">// а в        // org.picketlink.identity.federation.core.saml.v2.writers.BaseWriter
        // есть проверка
        // if (subjectConfirmationData != null) {
        // write(subjectConfirmationData); }
        // где в свою очередь будет искаться
        // KeyInfoConfirmationDataType
        // который может здесь установиться
        // sct.setSubjectConfirmationData(KeyInfoConfirmationDataType type);
        // а в нём будет искаться /KeyInfoType
        // но его в токене от IDP нет, поэтому возможно исключение

        // итог
        // для токена от IDP не устанавливать
       // sct.setSubjectConfirmationData(type);
        // токен от IDP определяется условием scdt.getAnyType()==null

        SubjectConfirmationType sct = oldAssertion.getSubject()
                .getConfirmation().get(0);

        SubjectConfirmationDataType scdt = sct.getSubjectConfirmationData();

        if (scdt != null &amp;&amp; scdt.getAnyType() != null) {
            KeyInfoConfirmationDataType type = new KeyInfoConfirmationDataType();
            type.setAnyType(scdt.getAnyType());

            sct.setSubjectConfirmationData(type);
        }

        // canceled assertions cannot be renewed.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                oldAssertion.getID())) {
            throw LOGGER
                    .samlAssertionRevokedCouldNotRenew(oldAssertion.getID());
        }

        // adjust the lifetime for the renewed assertion.
        ConditionsType conditions = oldAssertion.getConditions();
        conditions.setNotBefore(context.getRequestSecurityToken().getLifetime()
                .getCreated());
        conditions.setNotOnOrAfter(context.getRequestSecurityToken()
                .getLifetime().getExpires());

        // create a new unique ID for the renewed assertion.
        String assertionID = IDGenerator.create(&quot;ID_&quot;);

        // !!!
        Principal principal = context.getCallerPrincipal();
         
        java.util.Set&lt;StatementAbstractType&gt; oldStatements = oldAssertion
                .getStatements();

        AttributeType tokenIDAttribute = null;
        String uidAttribute = null;

        for (StatementAbstractType oldSt : oldStatements) {
            if (oldSt instanceof AttributeStatementType) {
                for (org.picketlink.identity.federation.saml.v2.assertion.AttributeStatementType.ASTChoiceType atr : ((AttributeStatementType) oldSt)
                        .getAttributes()) {
                    if (&quot;TOKEN_ID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:02:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        tokenIDAttribute = atr.getAttribute();

                    } else if (&quot;USER_UID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:03:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        uidAttribute = (String) atr.getAttribute()
                                .getAttributeValue().get(0);
                    }
                }
            }/*else if(oldSt instanceof AuthnStatementType){
                
            //впринципе, сам sts не продляет AuthnInstant у saml:AuthnStatement при renew
            //так что и мы не будем	
            //то есть, saml:AuthnStatement переносится какой есть.   
            try{    
                
                URI authContextDeclRef = null;
                Set&lt;URI&gt; list = ((AuthnStatementType) oldSt).getAuthnContext().getAuthenticatingAuthority();
                        
                if(list!=null &amp;&amp;!list.isEmpty()){
                    authContextDeclRef = list.iterator().next() ;   
                }
                
                XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();
                oldSt = new AuthnStatementType(currentTime);
            
                AuthnContextType act = new AuthnContextType();
                
                AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();
                
                AuthnContextClassRefType classRef = new AuthnContextClassRefType(
                        authContextDeclRef!=null?
                                authContextDeclRef:
                                URI.create(JBossSAMLURIConstants.AC_PASSWORD.get()));
                sequence.setClassRef(classRef);
                act.setSequence(sequence); 
            
                     
                ((AuthnStatementType)oldSt).setAuthnContext(act);
            
                
            } catch (Exception e) {
                 LOGGERSLF4J.error(&quot;renewToken:currentTime:error:&quot;+e);
            }

            }*/
        }

        LOGGERSLF4J.debug(&quot;renewToken:04&quot;);

        if (tokenIDAttribute != null) {
            if (tokenIDAttribute.getAttributeValue() != null) {
                tokenIDAttribute.removeAttributeValue(tokenIDAttribute
                        .getAttributeValue().get(0));
            }

            String lifetimeMs = Long.toString(context.getRequestSecurityToken()
                    .getLifetime().getExpires().toGregorianCalendar()
                    .getTimeInMillis());

            tokenIDAttribute
                    .addAttributeValue(new CUDSAML20CommonTokenRoleAttributeProvider()
                            .tokenIDCreate(uidAttribute, ((CudPrincipal)principal).getAuthType(), lifetimeMs));
        }

        List&lt;StatementAbstractType&gt; statements = new ArrayList&lt;StatementAbstractType&gt;();
        statements.addAll(oldAssertion.getStatements());

        // create the new assertion.
        AssertionType newAssertion = SAMLAssertionFactory.createAssertion(
                assertionID, oldAssertion.getIssuer(), context
                        .getRequestSecurityToken().getLifetime().getCreated(),
                conditions, oldAssertion.getSubject(), statements);

        // create a security token with the new assertion.
        Element assertionElement = null;
        try {
            assertionElement = SAMLUtil.toElement(newAssertion);
        } catch (Exception e) {
            throw LOGGER.samlAssertionMarshallError(e);
        }

        LOGGERSLF4J.debug(&quot;renewToken:02++&quot;);

        SecurityToken securityToken = new StandardSecurityToken(context
                .getRequestSecurityToken().getTokenType().toString(),
                assertionElement, assertionID);
        context.setSecurityToken(securityToken);

        // set the SAML assertion attached reference.
        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(
                SAMLUtil.SAML2_VALUE_TYPE, &quot;#&quot; + assertionID);
        Map&lt;QName, String&gt; attributes = new HashMap&lt;QName, String&gt;();
        attributes.put(new QName(WSTrustConstants.WSSE11_NS, &quot;TokenType&quot;),
                SAMLUtil.SAML2_TOKEN_TYPE);
        RequestedReferenceType attachedReference = WSTrustUtil
                .createRequestedReference(keyIdentifier, attributes);
        context.setAttachedReference(attachedReference);
    }

    /*
     * (non-Javadoc)
     * 
     * @see
     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#
     * validateToken
     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)
     */
    public void validateToken(ProtocolContext protoContext)
            throws ProcessingException {
        if (!(protoContext instanceof WSTrustRequestContext)) {
            return;
        }

        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;

        LOGGER.trace(&quot;SAML token validation started&quot;);

        // get the SAML assertion that must be validated.
        Element token = context.getRequestSecurityToken()
                .getValidateTargetElement();
        if (token == null) {
            throw LOGGER.wsTrustNullValidationTargetError();
        }

        String code = WSTrustConstants.STATUS_CODE_VALID;
        String reason = &quot;SAMLV2.0 Assertion successfuly validated&quot;;

        AssertionType assertion = null;
        Element assertionElement = (Element) token.getFirstChild();
        if (!this.isAssertion(assertionElement)) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: supplied token is not a SAMLV2.0 Assertion&quot;;
        } else {
            try {
                if (LOGGER.isTraceEnabled()) {
                    LOGGER.samlAssertion(DocumentUtil
                            .getNodeAsString(assertionElement));
                }
                assertion = SAMLUtil.fromElement(assertionElement);
            } catch (Exception e) {
                throw LOGGER.samlAssertionUnmarshallError(e);
            }
        }

        // check if the assertion has been canceled before.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                assertion.getID())) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: assertion with id &quot;
                    + assertion.getID() + &quot; has been canceled&quot;;
        }

        // check the assertion lifetime.
        try {
            if (AssertionUtil.hasExpired(assertion)) {
                code = WSTrustConstants.STATUS_CODE_INVALID;
                reason = &quot;Validation failure: assertion expired or used before its lifetime period&quot;;
            }
        } catch (Exception ce) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: unable to verify assertion lifetime: &quot;
                    + ce.getMessage();
        }

        // construct the status and set it on the request context.
        StatusType status = new StatusType();
        status.setCode(code);
        status.setReason(reason);
        context.setStatus(status);
    }

    /**
     * &lt;p&gt;
     * Checks whether the specified element is a SAMLV2.0 assertion or not.
     * &lt;/p&gt;
     * 
     * @param element
     *            the {@code Element} being verified.
     * @return {@code true} if the element is a SAMLV2.0 assertion;
     *         {@code false} otherwise.
     */
    private boolean isAssertion(Element element) {
        return element == null ? false : &quot;Assertion&quot;.equals(element
                .getLocalName())
                &amp;&amp; WSTrustConstants.SAML2_ASSERTION_NS.equals(element
                        .getNamespaceURI());
    }

    /**
     * @see {@code SecurityTokenProvider#supports(String)}
     */
    public boolean supports(String namespace) {
        return WSTrustConstants.BASE_NAMESPACE.equals(namespace);
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#tokenType()
     */
    public String tokenType() {
        return SAMLUtil.SAML2_TOKEN_TYPE;
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#getSupportedQName()
     */
    public QName getSupportedQName() {
        return new QName(tokenType(), JBossSAMLConstants.ASSERTION.get());
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#family()
     */
    public String family() {
        return SecurityTokenProvider.FAMILY_TYPE.WS_TRUST.toString();
    }
}</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        <span class="comment">// org.picketlink.identity.federation.core.saml.v2.writers.BaseWriter</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="comment">// есть проверка</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="comment">// if (subjectConfirmationData != null) {</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="comment">// write(subjectConfirmationData); }</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        <span class="comment">// где в свою очередь будет искаться</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <span class="comment">// KeyInfoConfirmationDataType</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="comment">// который может здесь установиться</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <span class="comment">// sct.setSubjectConfirmationData(KeyInfoConfirmationDataType type);</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        <span class="comment">// а в нём будет искаться /KeyInfoType</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <span class="comment">// но его в токене от IDP нет, поэтому возможно исключение 
        // итог
        // для токена от IDP не устанавливать
       // sct.setSubjectConfirmationData(type);
        // токен от IDP определяется условием scdt.getAnyType()==null

        SubjectConfirmationType sct = oldAssertion.getSubject()
                .getConfirmation().get(0);

        SubjectConfirmationDataType scdt = sct.getSubjectConfirmationData();

        if (scdt != null &amp;&amp; scdt.getAnyType() != null) {
            KeyInfoConfirmationDataType type = new KeyInfoConfirmationDataType();
            type.setAnyType(scdt.getAnyType());

            sct.setSubjectConfirmationData(type);
        }

        // canceled assertions cannot be renewed.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                oldAssertion.getID())) {
            throw LOGGER
                    .samlAssertionRevokedCouldNotRenew(oldAssertion.getID());
        }

        // adjust the lifetime for the renewed assertion.
        ConditionsType conditions = oldAssertion.getConditions();
        conditions.setNotBefore(context.getRequestSecurityToken().getLifetime()
                .getCreated());
        conditions.setNotOnOrAfter(context.getRequestSecurityToken()
                .getLifetime().getExpires());

        // create a new unique ID for the renewed assertion.
        String assertionID = IDGenerator.create(&quot;ID_&quot;);

        // !!!
        Principal principal = context.getCallerPrincipal();
         
        java.util.Set&lt;StatementAbstractType&gt; oldStatements = oldAssertion
                .getStatements();

        AttributeType tokenIDAttribute = null;
        String uidAttribute = null;

        for (StatementAbstractType oldSt : oldStatements) {
            if (oldSt instanceof AttributeStatementType) {
                for (org.picketlink.identity.federation.saml.v2.assertion.AttributeStatementType.ASTChoiceType atr : ((AttributeStatementType) oldSt)
                        .getAttributes()) {
                    if (&quot;TOKEN_ID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:02:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        tokenIDAttribute = atr.getAttribute();

                    } else if (&quot;USER_UID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:03:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        uidAttribute = (String) atr.getAttribute()
                                .getAttributeValue().get(0);
                    }
                }
            }/*else if(oldSt instanceof AuthnStatementType){
                
            //впринципе, сам sts не продляет AuthnInstant у saml:AuthnStatement при renew
            //так что и мы не будем	
            //то есть, saml:AuthnStatement переносится какой есть.   
            try{    
                
                URI authContextDeclRef = null;
                Set&lt;URI&gt; list = ((AuthnStatementType) oldSt).getAuthnContext().getAuthenticatingAuthority();
                        
                if(list!=null &amp;&amp;!list.isEmpty()){
                    authContextDeclRef = list.iterator().next() ;   
                }
                
                XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();
                oldSt = new AuthnStatementType(currentTime);
            
                AuthnContextType act = new AuthnContextType();
                
                AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();
                
                AuthnContextClassRefType classRef = new AuthnContextClassRefType(
                        authContextDeclRef!=null?
                                authContextDeclRef:
                                URI.create(JBossSAMLURIConstants.AC_PASSWORD.get()));
                sequence.setClassRef(classRef);
                act.setSequence(sequence); 
            
                     
                ((AuthnStatementType)oldSt).setAuthnContext(act);
            
                
            } catch (Exception e) {
                 LOGGERSLF4J.error(&quot;renewToken:currentTime:error:&quot;+e);
            }

            }*/
        }

        LOGGERSLF4J.debug(&quot;renewToken:04&quot;);

        if (tokenIDAttribute != null) {
            if (tokenIDAttribute.getAttributeValue() != null) {
                tokenIDAttribute.removeAttributeValue(tokenIDAttribute
                        .getAttributeValue().get(0));
            }

            String lifetimeMs = Long.toString(context.getRequestSecurityToken()
                    .getLifetime().getExpires().toGregorianCalendar()
                    .getTimeInMillis());

            tokenIDAttribute
                    .addAttributeValue(new CUDSAML20CommonTokenRoleAttributeProvider()
                            .tokenIDCreate(uidAttribute, ((CudPrincipal)principal).getAuthType(), lifetimeMs));
        }

        List&lt;StatementAbstractType&gt; statements = new ArrayList&lt;StatementAbstractType&gt;();
        statements.addAll(oldAssertion.getStatements());

        // create the new assertion.
        AssertionType newAssertion = SAMLAssertionFactory.createAssertion(
                assertionID, oldAssertion.getIssuer(), context
                        .getRequestSecurityToken().getLifetime().getCreated(),
                conditions, oldAssertion.getSubject(), statements);

        // create a security token with the new assertion.
        Element assertionElement = null;
        try {
            assertionElement = SAMLUtil.toElement(newAssertion);
        } catch (Exception e) {
            throw LOGGER.samlAssertionMarshallError(e);
        }

        LOGGERSLF4J.debug(&quot;renewToken:02++&quot;);

        SecurityToken securityToken = new StandardSecurityToken(context
                .getRequestSecurityToken().getTokenType().toString(),
                assertionElement, assertionID);
        context.setSecurityToken(securityToken);

        // set the SAML assertion attached reference.
        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(
                SAMLUtil.SAML2_VALUE_TYPE, &quot;#&quot; + assertionID);
        Map&lt;QName, String&gt; attributes = new HashMap&lt;QName, String&gt;();
        attributes.put(new QName(WSTrustConstants.WSSE11_NS, &quot;TokenType&quot;),
                SAMLUtil.SAML2_TOKEN_TYPE);
        RequestedReferenceType attachedReference = WSTrustUtil
                .createRequestedReference(keyIdentifier, attributes);
        context.setAttachedReference(attachedReference);
    }

    /*
     * (non-Javadoc)
     * 
     * @see
     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#
     * validateToken
     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)
     */
    public void validateToken(ProtocolContext protoContext)
            throws ProcessingException {
        if (!(protoContext instanceof WSTrustRequestContext)) {
            return;
        }

        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;

        LOGGER.trace(&quot;SAML token validation started&quot;);

        // get the SAML assertion that must be validated.
        Element token = context.getRequestSecurityToken()
                .getValidateTargetElement();
        if (token == null) {
            throw LOGGER.wsTrustNullValidationTargetError();
        }

        String code = WSTrustConstants.STATUS_CODE_VALID;
        String reason = &quot;SAMLV2.0 Assertion successfuly validated&quot;;

        AssertionType assertion = null;
        Element assertionElement = (Element) token.getFirstChild();
        if (!this.isAssertion(assertionElement)) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: supplied token is not a SAMLV2.0 Assertion&quot;;
        } else {
            try {
                if (LOGGER.isTraceEnabled()) {
                    LOGGER.samlAssertion(DocumentUtil
                            .getNodeAsString(assertionElement));
                }
                assertion = SAMLUtil.fromElement(assertionElement);
            } catch (Exception e) {
                throw LOGGER.samlAssertionUnmarshallError(e);
            }
        }

        // check if the assertion has been canceled before.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                assertion.getID())) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: assertion with id &quot;
                    + assertion.getID() + &quot; has been canceled&quot;;
        }

        // check the assertion lifetime.
        try {
            if (AssertionUtil.hasExpired(assertion)) {
                code = WSTrustConstants.STATUS_CODE_INVALID;
                reason = &quot;Validation failure: assertion expired or used before its lifetime period&quot;;
            }
        } catch (Exception ce) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: unable to verify assertion lifetime: &quot;
                    + ce.getMessage();
        }

        // construct the status and set it on the request context.
        StatusType status = new StatusType();
        status.setCode(code);
        status.setReason(reason);
        context.setStatus(status);
    }

    /**
     * &lt;p&gt;
     * Checks whether the specified element is a SAMLV2.0 assertion or not.
     * &lt;/p&gt;
     * 
     * @param element
     *            the {@code Element} being verified.
     * @return {@code true} if the element is a SAMLV2.0 assertion;
     *         {@code false} otherwise.
     */
    private boolean isAssertion(Element element) {
        return element == null ? false : &quot;Assertion&quot;.equals(element
                .getLocalName())
                &amp;&amp; WSTrustConstants.SAML2_ASSERTION_NS.equals(element
                        .getNamespaceURI());
    }

    /**
     * @see {@code SecurityTokenProvider#supports(String)}
     */
    public boolean supports(String namespace) {
        return WSTrustConstants.BASE_NAMESPACE.equals(namespace);
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#tokenType()
     */
    public String tokenType() {
        return SAMLUtil.SAML2_TOKEN_TYPE;
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#getSupportedQName()
     */
    public QName getSupportedQName() {
        return new QName(tokenType(), JBossSAMLConstants.ASSERTION.get());
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#family()
     */
    public String family() {
        return SecurityTokenProvider.FAMILY_TYPE.WS_TRUST.toString();
    }
}</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        <span class="comment">// итог</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        <span class="comment">// для токена от IDP не устанавливать        // sct.setSubjectConfirmationData(type);
        // токен от IDP определяется условием scdt.getAnyType()==null

        SubjectConfirmationType sct = oldAssertion.getSubject()
                .getConfirmation().get(0);

        SubjectConfirmationDataType scdt = sct.getSubjectConfirmationData();

        if (scdt != null &amp;&amp; scdt.getAnyType() != null) {
            KeyInfoConfirmationDataType type = new KeyInfoConfirmationDataType();
            type.setAnyType(scdt.getAnyType());

            sct.setSubjectConfirmationData(type);
        }

        // canceled assertions cannot be renewed.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                oldAssertion.getID())) {
            throw LOGGER
                    .samlAssertionRevokedCouldNotRenew(oldAssertion.getID());
        }

        // adjust the lifetime for the renewed assertion.
        ConditionsType conditions = oldAssertion.getConditions();
        conditions.setNotBefore(context.getRequestSecurityToken().getLifetime()
                .getCreated());
        conditions.setNotOnOrAfter(context.getRequestSecurityToken()
                .getLifetime().getExpires());

        // create a new unique ID for the renewed assertion.
        String assertionID = IDGenerator.create(&quot;ID_&quot;);

        // !!!
        Principal principal = context.getCallerPrincipal();
         
        java.util.Set&lt;StatementAbstractType&gt; oldStatements = oldAssertion
                .getStatements();

        AttributeType tokenIDAttribute = null;
        String uidAttribute = null;

        for (StatementAbstractType oldSt : oldStatements) {
            if (oldSt instanceof AttributeStatementType) {
                for (org.picketlink.identity.federation.saml.v2.assertion.AttributeStatementType.ASTChoiceType atr : ((AttributeStatementType) oldSt)
                        .getAttributes()) {
                    if (&quot;TOKEN_ID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:02:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        tokenIDAttribute = atr.getAttribute();

                    } else if (&quot;USER_UID&quot;.equals(atr.getAttribute().getName())) {
                        LOGGERSLF4J
                                .info(&quot;renewToken:03:&quot;
                                        + atr.getAttribute()
                                                .getAttributeValue().get(0));

                        uidAttribute = (String) atr.getAttribute()
                                .getAttributeValue().get(0);
                    }
                }
            }/*else if(oldSt instanceof AuthnStatementType){
                
            //впринципе, сам sts не продляет AuthnInstant у saml:AuthnStatement при renew
            //так что и мы не будем	
            //то есть, saml:AuthnStatement переносится какой есть.   
            try{    
                
                URI authContextDeclRef = null;
                Set&lt;URI&gt; list = ((AuthnStatementType) oldSt).getAuthnContext().getAuthenticatingAuthority();
                        
                if(list!=null &amp;&amp;!list.isEmpty()){
                    authContextDeclRef = list.iterator().next() ;   
                }
                
                XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();
                oldSt = new AuthnStatementType(currentTime);
            
                AuthnContextType act = new AuthnContextType();
                
                AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();
                
                AuthnContextClassRefType classRef = new AuthnContextClassRefType(
                        authContextDeclRef!=null?
                                authContextDeclRef:
                                URI.create(JBossSAMLURIConstants.AC_PASSWORD.get()));
                sequence.setClassRef(classRef);
                act.setSequence(sequence); 
            
                     
                ((AuthnStatementType)oldSt).setAuthnContext(act);
            
                
            } catch (Exception e) {
                 LOGGERSLF4J.error(&quot;renewToken:currentTime:error:&quot;+e);
            }

            }*/
        }

        LOGGERSLF4J.debug(&quot;renewToken:04&quot;);

        if (tokenIDAttribute != null) {
            if (tokenIDAttribute.getAttributeValue() != null) {
                tokenIDAttribute.removeAttributeValue(tokenIDAttribute
                        .getAttributeValue().get(0));
            }

            String lifetimeMs = Long.toString(context.getRequestSecurityToken()
                    .getLifetime().getExpires().toGregorianCalendar()
                    .getTimeInMillis());

            tokenIDAttribute
                    .addAttributeValue(new CUDSAML20CommonTokenRoleAttributeProvider()
                            .tokenIDCreate(uidAttribute, ((CudPrincipal)principal).getAuthType(), lifetimeMs));
        }

        List&lt;StatementAbstractType&gt; statements = new ArrayList&lt;StatementAbstractType&gt;();
        statements.addAll(oldAssertion.getStatements());

        // create the new assertion.
        AssertionType newAssertion = SAMLAssertionFactory.createAssertion(
                assertionID, oldAssertion.getIssuer(), context
                        .getRequestSecurityToken().getLifetime().getCreated(),
                conditions, oldAssertion.getSubject(), statements);

        // create a security token with the new assertion.
        Element assertionElement = null;
        try {
            assertionElement = SAMLUtil.toElement(newAssertion);
        } catch (Exception e) {
            throw LOGGER.samlAssertionMarshallError(e);
        }

        LOGGERSLF4J.debug(&quot;renewToken:02++&quot;);

        SecurityToken securityToken = new StandardSecurityToken(context
                .getRequestSecurityToken().getTokenType().toString(),
                assertionElement, assertionID);
        context.setSecurityToken(securityToken);

        // set the SAML assertion attached reference.
        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(
                SAMLUtil.SAML2_VALUE_TYPE, &quot;#&quot; + assertionID);
        Map&lt;QName, String&gt; attributes = new HashMap&lt;QName, String&gt;();
        attributes.put(new QName(WSTrustConstants.WSSE11_NS, &quot;TokenType&quot;),
                SAMLUtil.SAML2_TOKEN_TYPE);
        RequestedReferenceType attachedReference = WSTrustUtil
                .createRequestedReference(keyIdentifier, attributes);
        context.setAttachedReference(attachedReference);
    }

    /*
     * (non-Javadoc)
     * 
     * @see
     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#
     * validateToken
     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)
     */
    public void validateToken(ProtocolContext protoContext)
            throws ProcessingException {
        if (!(protoContext instanceof WSTrustRequestContext)) {
            return;
        }

        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;

        LOGGER.trace(&quot;SAML token validation started&quot;);

        // get the SAML assertion that must be validated.
        Element token = context.getRequestSecurityToken()
                .getValidateTargetElement();
        if (token == null) {
            throw LOGGER.wsTrustNullValidationTargetError();
        }

        String code = WSTrustConstants.STATUS_CODE_VALID;
        String reason = &quot;SAMLV2.0 Assertion successfuly validated&quot;;

        AssertionType assertion = null;
        Element assertionElement = (Element) token.getFirstChild();
        if (!this.isAssertion(assertionElement)) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: supplied token is not a SAMLV2.0 Assertion&quot;;
        } else {
            try {
                if (LOGGER.isTraceEnabled()) {
                    LOGGER.samlAssertion(DocumentUtil
                            .getNodeAsString(assertionElement));
                }
                assertion = SAMLUtil.fromElement(assertionElement);
            } catch (Exception e) {
                throw LOGGER.samlAssertionUnmarshallError(e);
            }
        }

        // check if the assertion has been canceled before.
        if (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,
                assertion.getID())) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: assertion with id &quot;
                    + assertion.getID() + &quot; has been canceled&quot;;
        }

        // check the assertion lifetime.
        try {
            if (AssertionUtil.hasExpired(assertion)) {
                code = WSTrustConstants.STATUS_CODE_INVALID;
                reason = &quot;Validation failure: assertion expired or used before its lifetime period&quot;;
            }
        } catch (Exception ce) {
            code = WSTrustConstants.STATUS_CODE_INVALID;
            reason = &quot;Validation failure: unable to verify assertion lifetime: &quot;
                    + ce.getMessage();
        }

        // construct the status and set it on the request context.
        StatusType status = new StatusType();
        status.setCode(code);
        status.setReason(reason);
        context.setStatus(status);
    }

    /**
     * &lt;p&gt;
     * Checks whether the specified element is a SAMLV2.0 assertion or not.
     * &lt;/p&gt;
     * 
     * @param element
     *            the {@code Element} being verified.
     * @return {@code true} if the element is a SAMLV2.0 assertion;
     *         {@code false} otherwise.
     */
    private boolean isAssertion(Element element) {
        return element == null ? false : &quot;Assertion&quot;.equals(element
                .getLocalName())
                &amp;&amp; WSTrustConstants.SAML2_ASSERTION_NS.equals(element
                        .getNamespaceURI());
    }

    /**
     * @see {@code SecurityTokenProvider#supports(String)}
     */
    public boolean supports(String namespace) {
        return WSTrustConstants.BASE_NAMESPACE.equals(namespace);
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#tokenType()
     */
    public String tokenType() {
        return SAMLUtil.SAML2_TOKEN_TYPE;
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#getSupportedQName()
     */
    public QName getSupportedQName() {
        return new QName(tokenType(), JBossSAMLConstants.ASSERTION.get());
    }

    /**
     * @see org.picketlink.identity.federation.core.interfaces.SecurityTokenProvider#family()
     */
    public String family() {
        return SecurityTokenProvider.FAMILY_TYPE.WS_TRUST.toString();
    }
}</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="comment">// sct.setSubjectConfirmationData(type);</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        <span class="comment">// токен от IDP определяется условием scdt.getAnyType()==null</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        SubjectConfirmationType sct = oldAssertion.getSubject()</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                .getConfirmation().get(0);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        SubjectConfirmationDataType scdt = sct.getSubjectConfirmationData();</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <span class="keywordflow">if</span> (scdt != null &amp;&amp; scdt.getAnyType() != null) {</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            KeyInfoConfirmationDataType type = <span class="keyword">new</span> KeyInfoConfirmationDataType();</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            type.setAnyType(scdt.getAnyType());</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            sct.setSubjectConfirmationData(type);</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        }</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="comment">// canceled assertions cannot be renewed.</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <span class="keywordflow">if</span> (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                oldAssertion.getID())) {</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;            <span class="keywordflow">throw</span> LOGGER</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                    .samlAssertionRevokedCouldNotRenew(oldAssertion.getID());</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        }</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="comment">// adjust the lifetime for the renewed assertion.</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        ConditionsType conditions = oldAssertion.getConditions();</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        conditions.setNotBefore(context.getRequestSecurityToken().getLifetime()</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                .getCreated());</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        conditions.setNotOnOrAfter(context.getRequestSecurityToken()</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                .getLifetime().getExpires());</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        <span class="comment">// create a new unique ID for the renewed assertion.</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        String assertionID = IDGenerator.create(<span class="stringliteral">&quot;ID_&quot;</span>);</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="comment">// !!!</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        Principal principal = context.getCallerPrincipal();</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;         </div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        java.util.Set&lt;StatementAbstractType&gt; oldStatements = oldAssertion</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                .getStatements();</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        AttributeType tokenIDAttribute = null;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        String uidAttribute = null;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="keywordflow">for</span> (StatementAbstractType oldSt : oldStatements) {</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;            <span class="keywordflow">if</span> (oldSt instanceof AttributeStatementType) {</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                <span class="keywordflow">for</span> (<a class="code" href="../../db/d96/namespaceorg.html">org</a>.picketlink.identity.federation.saml.v2.assertion.AttributeStatementType.ASTChoiceType atr : ((AttributeStatementType) oldSt)</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                        .getAttributes()) {</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                    <span class="keywordflow">if</span> (<span class="stringliteral">&quot;TOKEN_ID&quot;</span>.equals(atr.getAttribute().getName())) {</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                        LOGGERSLF4J</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                                .info(<span class="stringliteral">&quot;renewToken:02:&quot;</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                                        + atr.getAttribute()</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                                                .getAttributeValue().get(0));</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                        tokenIDAttribute = atr.getAttribute();</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="stringliteral">&quot;USER_UID&quot;</span>.equals(atr.getAttribute().getName())) {</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                        LOGGERSLF4J</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                                .info(<span class="stringliteral">&quot;renewToken:03:&quot;</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                                        + atr.getAttribute()</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                                                .getAttributeValue().get(0));</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                        uidAttribute = (String) atr.getAttribute()</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                                .getAttributeValue().get(0);</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                    }</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                }</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;            }<span class="comment">/*else if(oldSt instanceof AuthnStatementType){</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="comment">                </span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment">            //впринципе, сам sts не продляет AuthnInstant у saml:AuthnStatement при renew</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">            //так что и мы не будем	</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">            //то есть, saml:AuthnStatement переносится какой есть.   </span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">            try{    </span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment">                </span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">                URI authContextDeclRef = null;</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="comment">                Set&lt;URI&gt; list = ((AuthnStatementType) oldSt).getAuthnContext().getAuthenticatingAuthority();</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="comment">                        </span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="comment">                if(list!=null &amp;&amp;!list.isEmpty()){</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment">                    authContextDeclRef = list.iterator().next() ;   </span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">                }</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">                </span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="comment">                XMLGregorianCalendar currentTime = XMLTimeUtil.getIssueInstant();</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="comment">                oldSt = new AuthnStatementType(currentTime);</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment">                AuthnContextType act = new AuthnContextType();</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">                </span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment">                AuthnContextType.AuthnContextTypeSequence sequence = act.new AuthnContextTypeSequence();</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment">                </span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">                AuthnContextClassRefType classRef = new AuthnContextClassRefType(</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">                        authContextDeclRef!=null?</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment">                                authContextDeclRef:</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">                                URI.create(JBossSAMLURIConstants.AC_PASSWORD.get()));</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="comment">                sequence.setClassRef(classRef);</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment">                act.setSequence(sequence); </span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="comment">                     </span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment">                ((AuthnStatementType)oldSt).setAuthnContext(act);</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="comment">            </span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="comment">                </span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="comment">            } catch (Exception e) {</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="comment">                 LOGGERSLF4J.error(&quot;renewToken:currentTime:error:&quot;+e);</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">            }</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">            }*/</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        }</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        LOGGERSLF4J.debug(<span class="stringliteral">&quot;renewToken:04&quot;</span>);</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        <span class="keywordflow">if</span> (tokenIDAttribute != null) {</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;            <span class="keywordflow">if</span> (tokenIDAttribute.getAttributeValue() != null) {</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                tokenIDAttribute.removeAttributeValue(tokenIDAttribute</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                        .getAttributeValue().<span class="keyword">get</span>(0));</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;            }</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;            String lifetimeMs = Long.toString(context.getRequestSecurityToken()</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                    .getLifetime().getExpires().toGregorianCalendar()</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                    .getTimeInMillis());</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            tokenIDAttribute</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                    .addAttributeValue(<span class="keyword">new</span> <a class="code" href="../../d2/dca/classru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core_1_1attrib_1_1_c_u_d_s_a_m_l20_common_token_role_attribute_provider.html">CUDSAML20CommonTokenRoleAttributeProvider</a>()</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                            .tokenIDCreate(uidAttribute, ((<a class="code" href="../../d9/dfc/classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal.html">CudPrincipal</a>)principal).getAuthType(), lifetimeMs));</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        }</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        List&lt;StatementAbstractType&gt; statements = <span class="keyword">new</span> ArrayList&lt;StatementAbstractType&gt;();</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        statements.addAll(oldAssertion.getStatements());</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        <span class="comment">// create the new assertion.</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        AssertionType newAssertion = SAMLAssertionFactory.createAssertion(</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                assertionID, oldAssertion.getIssuer(), context</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                        .getRequestSecurityToken().getLifetime().getCreated(),</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                conditions, oldAssertion.getSubject(), statements);</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        <span class="comment">// create a security token with the new assertion.</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        Element assertionElement = null;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            assertionElement = SAMLUtil.toElement(newAssertion);</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;            <span class="keywordflow">throw</span> LOGGER.samlAssertionMarshallError(e);</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        }</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        LOGGERSLF4J.debug(<span class="stringliteral">&quot;renewToken:02++&quot;</span>);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        SecurityToken securityToken = <span class="keyword">new</span> StandardSecurityToken(context</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                .getRequestSecurityToken().getTokenType().toString(),</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                assertionElement, assertionID);</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        context.setSecurityToken(securityToken);</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <span class="comment">// set the SAML assertion attached reference.</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        KeyIdentifierType keyIdentifier = WSTrustUtil.createKeyIdentifier(</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                SAMLUtil.SAML2_VALUE_TYPE, <span class="stringliteral">&quot;#&quot;</span> + assertionID);</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        Map&lt;QName, String&gt; attributes = <span class="keyword">new</span> HashMap&lt;QName, String&gt;();</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        attributes.put(<span class="keyword">new</span> QName(WSTrustConstants.WSSE11_NS, <span class="stringliteral">&quot;TokenType&quot;</span>),</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                SAMLUtil.SAML2_TOKEN_TYPE);</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        RequestedReferenceType attachedReference = WSTrustUtil</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                .createRequestedReference(keyIdentifier, attributes);</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        context.setAttachedReference(attachedReference);</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    }</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="comment">     * (non-Javadoc)</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">     * </span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="comment">     * @see</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="comment">     * org.picketlink.identity.federation.core.wstrust.SecurityTokenProvider#</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="comment">     * validateToken</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="comment">     * (org.picketlink.identity.federation.core.wstrust.WSTrustRequestContext)</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00591"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a42e42757fb500c884ad0d668a020ab98">  591</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a42e42757fb500c884ad0d668a020ab98">validateToken</a>(ProtocolContext protoContext)</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            <span class="keywordflow">throws</span> ProcessingException {</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        <span class="keywordflow">if</span> (!(protoContext instanceof WSTrustRequestContext)) {</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        }</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        WSTrustRequestContext context = (WSTrustRequestContext) protoContext;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        LOGGER.trace(<span class="stringliteral">&quot;SAML token validation started&quot;</span>);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        <span class="comment">// get the SAML assertion that must be validated.</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        Element token = context.getRequestSecurityToken()</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                .getValidateTargetElement();</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="keywordflow">if</span> (token == null) {</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;            <span class="keywordflow">throw</span> LOGGER.wsTrustNullValidationTargetError();</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        }</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        String code = WSTrustConstants.STATUS_CODE_VALID;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        String reason = <span class="stringliteral">&quot;SAMLV2.0 Assertion successfuly validated&quot;</span>;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        AssertionType assertion = null;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        Element assertionElement = (Element) token.getFirstChild();</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        <span class="keywordflow">if</span> (!this.<a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#aa774cd699193c4c7aba221f105bd95c2">isAssertion</a>(assertionElement)) {</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            code = WSTrustConstants.STATUS_CODE_INVALID;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            reason = <span class="stringliteral">&quot;Validation failure: supplied token is not a SAMLV2.0 Assertion&quot;</span>;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;            <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                <span class="keywordflow">if</span> (LOGGER.isTraceEnabled()) {</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                    LOGGER.samlAssertion(DocumentUtil</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                            .getNodeAsString(assertionElement));</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                }</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                assertion = SAMLUtil.fromElement(assertionElement);</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;            } <span class="keywordflow">catch</span> (Exception e) {</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                <span class="keywordflow">throw</span> LOGGER.samlAssertionUnmarshallError(e);</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            }</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        }</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        <span class="comment">// check if the assertion has been canceled before.</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        <span class="keywordflow">if</span> (this.revocationRegistry.isRevoked(SAMLUtil.SAML2_TOKEN_TYPE,</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                assertion.getID())) {</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            code = WSTrustConstants.STATUS_CODE_INVALID;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            reason = <span class="stringliteral">&quot;Validation failure: assertion with id &quot;</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                    + assertion.getID() + <span class="stringliteral">&quot; has been canceled&quot;</span>;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        }</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="comment">// check the assertion lifetime.</span></div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            <span class="keywordflow">if</span> (AssertionUtil.hasExpired(assertion)) {</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                code = WSTrustConstants.STATUS_CODE_INVALID;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                reason = <span class="stringliteral">&quot;Validation failure: assertion expired or used before its lifetime period&quot;</span>;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            }</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        } <span class="keywordflow">catch</span> (Exception ce) {</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;            code = WSTrustConstants.STATUS_CODE_INVALID;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;            reason = <span class="stringliteral">&quot;Validation failure: unable to verify assertion lifetime: &quot;</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                    + ce.getMessage();</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        }</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <span class="comment">// construct the status and set it on the request context.</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        StatusType status = <span class="keyword">new</span> StatusType();</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        status.setCode(code);</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        status.setReason(reason);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        context.setStatus(status);</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    }</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;</div>
<div class="line"><a name="l00665"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#aa774cd699193c4c7aba221f105bd95c2">  665</a></span>&#160;    <span class="keyword">private</span> <span class="keywordtype">boolean</span> <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#aa774cd699193c4c7aba221f105bd95c2">isAssertion</a>(Element element) {</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        <span class="keywordflow">return</span> element == null ? <span class="keyword">false</span> : <span class="stringliteral">&quot;Assertion&quot;</span>.equals(element</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                .getLocalName())</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                &amp;&amp; WSTrustConstants.SAML2_ASSERTION_NS.equals(element</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                        .getNamespaceURI());</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    }</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div>
<div class="line"><a name="l00675"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a68321c9536410c23fa464043b6294f6c">  675</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a68321c9536410c23fa464043b6294f6c">supports</a>(String <span class="keyword">namespace</span>) {</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;        <span class="keywordflow">return</span> WSTrustConstants.BASE_NAMESPACE.equals(<span class="keyword">namespace</span>);</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    }</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;</div>
<div class="line"><a name="l00682"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a8424087e65c73f9ae11d8f1bcdde3164">  682</a></span>&#160;    <span class="keyword">public</span> String <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a8424087e65c73f9ae11d8f1bcdde3164">tokenType</a>() {</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        <span class="keywordflow">return</span> SAMLUtil.SAML2_TOKEN_TYPE;</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    }</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div>
<div class="line"><a name="l00689"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a762561f58fc79235aeb30b552dde900a">  689</a></span>&#160;    <span class="keyword">public</span> QName <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a762561f58fc79235aeb30b552dde900a">getSupportedQName</a>() {</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">new</span> QName(<a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a8424087e65c73f9ae11d8f1bcdde3164">tokenType</a>(), JBossSAMLConstants.ASSERTION.get());</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    }</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;</div>
<div class="line"><a name="l00696"></a><span class="lineno"><a class="line" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a199eac8387d2f4cc9e44aaa656a683c0">  696</a></span>&#160;    <span class="keyword">public</span> String <a class="code" href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a199eac8387d2f4cc9e44aaa656a683c0">family</a>() {</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="keywordflow">return</span> SecurityTokenProvider.FAMILY_TYPE.WS_TRUST.toString();</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    }</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;}</div>
<div class="ttc" id="namespaceru_1_1spb_1_1iac_1_1cud_1_1sts_html"><div class="ttname"><a href="../../d8/df8/namespaceru_1_1spb_1_1iac_1_1cud_1_1sts.html">ru.spb.iac.cud.sts</a></div></div>
<div class="ttc" id="namespaceru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core_html"><div class="ttname"><a href="../../d0/d1b/namespaceru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core.html">ru.spb.iac.cud.sts.core</a></div></div>
<div class="ttc" id="namespaceru_1_1spb_1_1iac_1_1cud_html"><div class="ttname"><a href="../../d1/df1/namespaceru_1_1spb_1_1iac_1_1cud.html">ru.spb.iac.cud</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a68321c9536410c23fa464043b6294f6c"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a68321c9536410c23fa464043b6294f6c">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.supports</a></div><div class="ttdeci">boolean supports(String namespace)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00675">CUDSAML20TokenProvider.java:675</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_ac705887d59b1f07a407a210c92217ab1"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#ac705887d59b1f07a407a210c92217ab1">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.attributeProvider</a></div><div class="ttdeci">SAML20TokenAttributeProvider attributeProvider</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00063">CUDSAML20TokenProvider.java:63</a></div></div>
<div class="ttc" id="namespaceru_1_1spb_1_1iac_html"><div class="ttname"><a href="../../db/dae/namespaceru_1_1spb_1_1iac.html">ru.spb.iac</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a199eac8387d2f4cc9e44aaa656a683c0"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a199eac8387d2f4cc9e44aaa656a683c0">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.family</a></div><div class="ttdeci">String family()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00696">CUDSAML20TokenProvider.java:696</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal_html"><div class="ttname"><a href="../../d9/dfc/classru_1_1spb_1_1iac_1_1cud_1_1util_1_1_cud_principal.html">ru.spb.iac.cud.util.CudPrincipal</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d87/_cud_principal_8java_source.html#l00005">CudPrincipal.java:5</a></div></div>
<div class="ttc" id="namespaceorg_html"><div class="ttname"><a href="../../db/d96/namespaceorg.html">org</a></div></div>
<div class="ttc" id="namespaceru_1_1spb_1_1iac_1_1cud_1_1util_html"><div class="ttname"><a href="../../d7/dd8/namespaceru_1_1spb_1_1iac_1_1cud_1_1util.html">ru.spb.iac.cud.util</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d9c/_common_util_8java_source.html#l00001">CommonUtil.java:1</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_security_actions_html"><div class="ttname"><a href="../../d0/d16/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_security_actions.html">ru.spb.iac.sts.core.plugins.saml.SecurityActions</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d13/sts-web_2src_2main_2java_2ru_2spb_2iac_2sts_2core_2plugins_2saml_2_security_actions_8java_source.html#l00005">SecurityActions.java:5</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a95e4dc39ec81e5c8d8e413ed70623e9c"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a95e4dc39ec81e5c8d8e413ed70623e9c">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.initialize</a></div><div class="ttdeci">void initialize(Map&lt; String, String &gt; properties)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00074">CUDSAML20TokenProvider.java:74</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a54a88306d84c02eb2287b98a18ebcf96"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a54a88306d84c02eb2287b98a18ebcf96">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.renewToken</a></div><div class="ttdeci">void renewToken(ProtocolContext protoContext)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00378">CUDSAML20TokenProvider.java:378</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_af40f5dbb6181c7bd4a5e3f6a9d83c41e"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#af40f5dbb6181c7bd4a5e3f6a9d83c41e">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.LOGGERSLF4J</a></div><div class="ttdeci">static final Logger LOGGERSLF4J</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00060">CUDSAML20TokenProvider.java:60</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core_1_1attrib_1_1_c_u_d_s_a_m_l20_common_token_role_attribute_provider_html"><div class="ttname"><a href="../../d2/dca/classru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core_1_1attrib_1_1_c_u_d_s_a_m_l20_common_token_role_attribute_provider.html">ru.spb.iac.cud.sts.core.attrib.CUDSAML20CommonTokenRoleAttributeProvider</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d4d/_c_u_d_s_a_m_l20_common_token_role_attribute_provider_8java_source.html#l00025">CUDSAML20CommonTokenRoleAttributeProvider.java:25</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a762561f58fc79235aeb30b552dde900a"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a762561f58fc79235aeb30b552dde900a">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.getSupportedQName</a></div><div class="ttdeci">QName getSupportedQName()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00689">CUDSAML20TokenProvider.java:689</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a4fe6e168e7ad9911f687a81bdc9c51fe"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a4fe6e168e7ad9911f687a81bdc9c51fe">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.useAbsoluteKeyIdentifier</a></div><div class="ttdeci">boolean useAbsoluteKeyIdentifier</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00065">CUDSAML20TokenProvider.java:65</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a5411903f749eddffdee3d553fb7c3bca"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a5411903f749eddffdee3d553fb7c3bca">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.LOGGER</a></div><div class="ttdeci">static final PicketLinkLogger LOGGER</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00057">CUDSAML20TokenProvider.java:57</a></div></div>
<div class="ttc" id="namespaceru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core_1_1attrib_html"><div class="ttname"><a href="../../d0/d24/namespaceru_1_1spb_1_1iac_1_1cud_1_1sts_1_1core_1_1attrib.html">ru.spb.iac.cud.sts.core.attrib</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d4d/_c_u_d_s_a_m_l20_common_token_role_attribute_provider_8java_source.html#l00001">CUDSAML20CommonTokenRoleAttributeProvider.java:1</a></div></div>
<div class="ttc" id="namespaceru_1_1spb_html"><div class="ttname"><a href="../../d6/d49/namespaceru_1_1spb.html">ru.spb</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a42e42757fb500c884ad0d668a020ab98"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a42e42757fb500c884ad0d668a020ab98">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.validateToken</a></div><div class="ttdeci">void validateToken(ProtocolContext protoContext)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00591">CUDSAML20TokenProvider.java:591</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_aa774cd699193c4c7aba221f105bd95c2"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#aa774cd699193c4c7aba221f105bd95c2">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.isAssertion</a></div><div class="ttdeci">boolean isAssertion(Element element)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00665">CUDSAML20TokenProvider.java:665</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a8424087e65c73f9ae11d8f1bcdde3164"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a8424087e65c73f9ae11d8f1bcdde3164">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.tokenType</a></div><div class="ttdeci">String tokenType()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00682">CUDSAML20TokenProvider.java:682</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_security_actions_html_ae8ba0c95fce44572318718f8bcc3eb81"><div class="ttname"><a href="../../d0/d16/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_security_actions.html#ae8ba0c95fce44572318718f8bcc3eb81">ru.spb.iac.sts.core.plugins.saml.SecurityActions.loadClass</a></div><div class="ttdeci">static Class loadClass(final Class&lt;?&gt; theClass, final String fullQualifiedName)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d13/sts-web_2src_2main_2java_2ru_2spb_2iac_2sts_2core_2plugins_2saml_2_security_actions_8java_source.html#l00008">SecurityActions.java:8</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_a70c89e2240b2652f4e5c9de24a505403"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#a70c89e2240b2652f4e5c9de24a505403">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.issueToken</a></div><div class="ttdeci">void issueToken(ProtocolContext protoContext)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00147">CUDSAML20TokenProvider.java:147</a></div></div>
<div class="ttc" id="namespaceru_html"><div class="ttname"><a href="../../d6/d63/namespaceru.html">ru</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html_ade5c20c9b1d8f6f7adfc95be56cff67f"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html#ade5c20c9b1d8f6f7adfc95be56cff67f">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider.cancelToken</a></div><div class="ttdeci">void cancelToken(ProtocolContext protoContext)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00114">CUDSAML20TokenProvider.java:114</a></div></div>
<div class="ttc" id="classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider_html"><div class="ttname"><a href="../../db/d4a/classru_1_1spb_1_1iac_1_1sts_1_1core_1_1plugins_1_1saml_1_1_c_u_d_s_a_m_l20_token_provider.html">ru.spb.iac.sts.core.plugins.saml.CUDSAML20TokenProvider</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java_source.html#l00054">CUDSAML20TokenProvider.java:54</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_9bec7083027963d9f9ceae2cc7474de5.html">git</a></li><li class="navelem"><a class="el" href="../../dir_864dd8e1fbe64106b015ff3e43ce6238.html">acc</a></li><li class="navelem"><a class="el" href="../../dir_052ce5837aaa9900adb3a816e480c0d2.html">ru.spb.iac.cud</a></li><li class="navelem"><a class="el" href="../../dir_ae5b8cc4daaaf7eeabbeae149509b94f.html">sts-web</a></li><li class="navelem"><a class="el" href="../../dir_1e13f51ac53ebdda4f67b80f26cc8b47.html">src</a></li><li class="navelem"><a class="el" href="../../dir_01c29be13601ef0137690659a67e0da3.html">main</a></li><li class="navelem"><a class="el" href="../../dir_b5a07d0771eba6329d8286d1772b9a9e.html">java</a></li><li class="navelem"><a class="el" href="../../dir_077f4aadfc4426b8a1a6728fa6b1e3d9.html">ru</a></li><li class="navelem"><a class="el" href="../../dir_3651120e738ce939d8efbbe9250f4f66.html">spb</a></li><li class="navelem"><a class="el" href="../../dir_3c2bc7641e64f778b8e5097ba0fd15b6.html">iac</a></li><li class="navelem"><a class="el" href="../../dir_7ed7f9c1a15973f04c65c4a3317778c8.html">sts</a></li><li class="navelem"><a class="el" href="../../dir_2e93019f0b1c453aa824105154f36515.html">core</a></li><li class="navelem"><a class="el" href="../../dir_3ddb91fcc9108645fe6370493b0c31e5.html">plugins</a></li><li class="navelem"><a class="el" href="../../dir_00580354281a95ec15ab22e230e1e595.html">saml</a></li><li class="navelem"><a class="el" href="../../d8/d3e/_c_u_d_s_a_m_l20_token_provider_8java.html">CUDSAML20TokenProvider.java</a></li>
    <li class="footer">Generated on Tue Dec 23 2014 20:16:53 for ru.spb.iac.cud by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
